---
title: "NCMP Analysis (2021/22 to 2023/24)"
format: 
  html:
    grid:
      body-width: 900px
    embed-resources: true
    output-file: index.html
toc: true
editor: visual
execute: 
  echo: false
---

```{r libraries/setup}
#| output: false
#| warning: false
library(tidyverse)
library(readxl)
library(pool)
library(odbc)
library(DBI)
library(fingertipsR)
library(ggiraph)
library(patchwork)
library(sf)
library(plotly)
library(leaflet)

bcc_colours <- c("#D00070", "#FFAD00", "#75BC22", "#84329B", "#00A9E0", "#3c3c3b")
```

```{r functions}
#| output: false
#| warning: false
#| 
# function to round an integer to nearest 5
# for data suppression purposes: https://digital.nhs.uk/data-and-information/find-data-and-publications/statement-of-administrative-sources/methodological-changes/changes-to-the-national-child-measurement-programme-2019-20-publication-content-and-disclosure-control-methodology#simple-calculations
round_5 <- function(x) {
  return(round(x / 5) * 5)
}

# function for calculating percent of a total and wilson confidence intervals
# where df is a dataframe containing a 'count' and a 'denominator' (must have these names)
# a is a column in df containing the count
# b is a column in df containing the denominator
# returns df with added cols containing percent of total, wilson_ci_upper and wilson_ci_lower

wilson_ci <- function(df, a, b) {
  df$id <- 1:nrow(df)
  wilson_df <- binom::binom.confint(a, b, methods = "wilson") |> 
    mutate(mean = mean * 100) |>
    mutate(lower = lower * 100) |>
    mutate(upper = upper * 100) |> 
    rename(pct = mean,
           count = x,
           denominator = n,
           lower_ci = lower,
           upper_ci = upper) |> 
    select(pct, count, denominator, lower_ci, upper_ci)
  wilson_df$id <- 1:nrow(wilson_df)
  left_join(df,
            wilson_df,
            by = c("id", "count", "denominator")) |> 
    select(-id) |> 
    mutate(pct = (round_5(count)/round_5(denominator))*100)
}


# function for an interactive heatmap
# assume columns in df called Year, School_Year, IDACI_2019_Quintile, Ethnicity, BMI_Category
# df = row by row df
# year = value of Year to filter on e.g. "2023/2024"
# school_year = value of School_Year to filter on e.g. "Year 6"
# category = BMI_Category to filter on e.g. "Obese"
# ref = reference for proportion test - combination of Ethnicity and IDACI quintile e.g. "White_3-5"
# white_text_threshold = value at which text in heatmap goes from black to white for readability
# suppression_value = value below which data should be suppressed

ineq_heatmap_interactive <- function(df, year, school_year, category, ref, white_text_threshold, suppression_value, idaci_grouped) {
  
  df <- df |> 
    mutate(IDACI_2019_Quintile = case_when(IDACI_2019_Quintile == "1" ~ "1",
                                           IDACI_2019_Quintile == "2" ~ "2",
                                           .default = "3-5"))
  
  df_md <- df |> 
    group_by(Year, School_Year, IDACI_2019_Quintile, Ethnicity, BMI_Category) |> 
    count() |> 
    ungroup()
  
  prop_test_input <- df |>
    filter(Year == year,
           School_Year == school_year) |>
    group_by(Ethnicity, IDACI_2019_Quintile) |>
    count(BMI_Category,
          name = "count") |>
    unite(col = "group",
          Ethnicity:IDACI_2019_Quintile) |>
    group_by(group) |> 
    mutate(total = sum(count),
           no = total - count) |> 
    rename(yes = count) |> 
    filter(BMI_Category == category) |> 
    select(group, yes, no)
  
  prop_test_input_rownames <- prop_test_input$group
  
  prop_test_input <- prop_test_input |> 
    ungroup() |> 
    select(-group) |> 
    as.matrix()
  
  rownames(prop_test_input) <- prop_test_input_rownames
  
  ref_1 <- paste0(ref, "_")
  ref_2 <- paste0("_", ref)
  
  prop_test_output <- rstatix::pairwise_prop_test(prop_test_input) |> 
    unite(col = "comparison",
          group1:group2) |> 
    filter(grepl(ref, comparison)) |> 
    mutate(comparison = str_remove(comparison, ref_1)) |> 
    mutate(comparison = str_remove(comparison, ref_2)) |> 
    separate_wider_delim(comparison,
                         delim = "_",
                         names = c("Ethnicity", "IDACI_2019_Quintile")) |>
    mutate(p.adj.signif = case_when(p.adj.signif == "ns" ~ "",
                                    .default = p.adj.signif))
  
  df_md_merged <- df_md |> 
    filter(Year == year,
           School_Year == school_year) |> 
    ungroup() |> 
    group_by(IDACI_2019_Quintile, Ethnicity) |> 
    mutate(total = sum(n),
           pct = (round_5(n)/round_5(total))*100) |> 
    filter(BMI_Category == category) |>
    left_join(prop_test_output,
              by = c("Ethnicity", "IDACI_2019_Quintile"))
  
  ref_ethnicity <- str_split_i(ref, "_", 1)
  ref_idaci <- str_split_i(ref, "_", 2)
  
  ref_pct <- df_md_merged |> 
    filter(Ethnicity == ref_ethnicity,
           IDACI_2019_Quintile == ref_idaci) |> 
    pull(pct)
  
  heatmap <- df_md_merged  |> 
    mutate(p.adj.signif = case_when(is.na(p.adj.signif) ~ "(Ref)",
                                    .default = p.adj.signif)) |> 
    mutate(text = case_when(n <= suppression_value ~ "Too small",
                            .default = paste0(round(pct, 2), "%", "\n", p.adj.signif))) |> 
    mutate(pct = case_when(n <= suppression_value ~ NA_real_,
                           .default = pct)) |> 
    mutate(text_colour = case_when(pct >= white_text_threshold ~ "white",
                                   .default = "black")) |> 
    mutate(direction = case_when(is.na(p.adj.signif) ~ "",
                                 p.adj.signif == "(Ref)" ~ "",
                                 p.adj.signif != "" & pct > ref_pct ~ "higher",
                                 p.adj.signif != "" & pct < ref_pct ~ "lower",
                                 .default = "")) |> 
    mutate(tooltip = case_when(n > 7 & direction != "" ~ paste0("IDACI Quintile ", IDACI_2019_Quintile, "\n",
                                                                Ethnicity, "\n",
                                                                round(pct, 2), "% ", BMI_Category, "\n",
                                                                n, " children", "\n",
                                                                "Sig. ", direction, " than reference"),
                               n > 7 & direction == "" ~ paste0("IDACI Quintile ", IDACI_2019_Quintile, "\n",
                                                                Ethnicity, "\n",
                                                                round(pct, 2), "% ", BMI_Category, "\n",
                                                                n, " children"),
                               n <= 7 ~ paste0("IDACI Quintile ", IDACI_2019_Quintile, "\n",
                                               Ethnicity, "\n",
                                               "Data suppressed"))) |> 
    mutate(IDACI_2019_Quintile = factor(IDACI_2019_Quintile,
                                        levels = c("3-5", "2", "1"))) |> 
    ggplot() +
    ggiraph::geom_tile_interactive(aes(x = Ethnicity,
                                       y = IDACI_2019_Quintile,
                                       fill = pct,
                                       tooltip = tooltip),
                                   colour = "white") +
    geom_text(aes(x = Ethnicity,
                  y = IDACI_2019_Quintile,
                  label = text,
                  color = text_colour)) +
    scale_fill_distiller(palette = "Purples",
                         direction = 1,
                         na.value = "lightgrey") +
    scale_colour_manual(values = c("black", "white")) +
    theme_classic() +
    theme(legend.position="none",
          panel.spacing = unit(0, "pt"),
          plot.margin = unit(c(0,0,0,0), 'lines')) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_discrete(expand = c(0, 0)) +
    xlab("Ethnicity") +
    ylab("IDACI Quintile")
  
  df_md_top_bars <- df |> 
    filter(Year == year,
           School_Year == school_year) |>
    group_by(BMI_Category, Ethnicity) |> 
    count(name = "count") |> 
    ungroup() |> 
    group_by(Ethnicity) |> 
    mutate(denominator = sum(count)) |> 
    filter(BMI_Category == category)
  
  df_md_top_bars <- wilson_ci(df_md_top_bars,
                              df_md_top_bars$count,
                              df_md_top_bars$denominator)
  
  top_bars <- df_md_top_bars |>
    mutate(tooltip = paste0(Ethnicity, "\n",
                            category, "\n",
                            round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)")) |> 
    ggplot(aes(x = Ethnicity,
               y = pct)) +
    ggiraph::geom_col_interactive(aes(tooltip = tooltip),
                                  fill = "#807dba") +
    geom_errorbar(aes(ymin = lower_ci,
                      ymax = upper_ci),
                  position = position_dodge(width = 0.9),
                  width = 0.2) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_continuous(expand = expansion(mult = c(0, 0.15)),
                       labels = scales::label_percent(scale = 1)) +
    theme_classic() +
    theme(legend.position="none",
          panel.spacing = unit(0, "pt"),
          axis.text.x = element_blank(),
          #axis.title.x = element_blank(),
          axis.ticks.x = element_blank(),
          # axis.line.y = element_line(colour = "black",
          #                            linewidth = 1),
          plot.margin = unit(c(0,0,0,0), 'lines')) +
    xlab("") +
    ylab(paste0(category, " % \n(", school_year, ")"))
  
  df_md_side_bars <- df |> 
    filter(Year == year,
           School_Year == school_year) |>
    group_by(BMI_Category, IDACI_2019_Quintile) |> 
    count(name = "count") |> 
    ungroup() |> 
    group_by(IDACI_2019_Quintile) |> 
    mutate(denominator = sum(count)) |> 
    filter(BMI_Category == category)
  
  df_md_side_bars <- wilson_ci(df_md_side_bars,
                               df_md_side_bars$count,
                               df_md_side_bars$denominator)
  
  side_bars <- df_md_side_bars |>
    mutate(IDACI_2019_Quintile = factor(IDACI_2019_Quintile,
                                        levels = c("3-5", "2", "1"))) |>
    mutate(tooltip = paste0("IDACI Quintile ",IDACI_2019_Quintile, "\n",
                            category, "\n",
                            round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)")) |> 
    ggplot(aes(x = pct,
               y = IDACI_2019_Quintile)) +
    ggiraph::geom_col_interactive(aes(tooltip = tooltip),
                                  fill = "#807dba") +
    geom_errorbar(aes(xmin = lower_ci,
                      xmax = upper_ci),
                  position = position_dodge(width = 0.9),
                  width = 0.2) +
    scale_y_discrete(expand = c(0, 0)) +
    scale_x_continuous(expand = expansion(mult = c(0, 0.15)),
                       labels = scales::label_percent(scale = 1)) +
    theme_classic() +
    theme(legend.position="none",
          panel.spacing = unit(0, "pt"),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          # axis.line.y = element_line(colour = "black",
          #                            linewidth = 1),
          plot.margin = unit(c(0,0,0,0), 'lines')) +
    ylab("") +
    xlab(paste0(category, " % \n(", school_year, ")"))
  
  empty_plot <- ggplot(df_md) +
    geom_blank()+
    theme_minimal()+
    coord_flip()+
    theme(axis.text.y = element_blank(),
          axis.title.y = element_blank(),
          axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          legend.position="none",
          plot.margin = unit(c(0,0,0,0), 'lines'))
  
  all_plots <- top_bars + empty_plot + heatmap + side_bars + plot_layout(widths = c(3, 1),
                                                                         heights = c(1, 3))
  ggiraph::girafe(ggobj = all_plots)
}

ineq_heatmap_interactive_mean <- function(df, year, school_year, category, white_text_threshold, suppression_value) {
  
  df <- df |> 
    mutate(IDACI_2019_Quintile = case_when(IDACI_2019_Quintile == "1" ~ "1",
                                           IDACI_2019_Quintile == "2" ~ "2",
                                           .default = "3-5"))
  
  df_md <- df |> 
    group_by(Year, School_Year, IDACI_2019_Quintile, Ethnicity, BMI_Category) |> 
    count(name = "count") |> 
    ungroup() |> 
    filter(Year == year,
           School_Year == school_year) |> 
    group_by(IDACI_2019_Quintile, Ethnicity) |> 
    mutate(denominator = sum(count)) |> 
    filter(BMI_Category == category)
  
  df_md_heatmap <- wilson_ci(df_md,
                             df_md$count,
                             df_md$denominator)
  
  all_bham <- df |> 
    group_by(Year, School_Year, BMI_Category) |> 
    count(name = "count") |> 
    ungroup() |> 
    group_by(Year, School_Year) |> 
    mutate(denominator = sum(count)) |> 
    filter(Year == year,
           School_Year == school_year,
           BMI_Category == category)
  
  all_bham <- wilson_ci(all_bham,
                        all_bham$count,
                        all_bham$denominator)
  
  all_bham_pct <- all_bham |> 
    pull(pct)
  
  all_bham_lower_ci <- all_bham |> 
    pull(lower_ci)
  
  all_bham_upper_ci <- all_bham |> 
    pull(upper_ci)
  
  heatmap <- df_md_heatmap |> 
    mutate(D = pct - all_bham_pct,
           D_lower = D - sqrt((pct - lower_ci)^2 + (all_bham_upper_ci - all_bham_pct)^2),
           D_upper = D + sqrt((pct - lower_ci)^2 + (all_bham_upper_ci - all_bham_pct)^2),
           # sig_diff = case_when(D_lower < 0 & D_upper < 0 ~ "*",
           #                      D_lower > 0 & D_upper > 0 ~ "*",
           #                      .default = ""),
           sig_diff = case_when(D_lower < 0 & D_upper < 0 ~ "↓",
                                D_lower > 0 & D_upper > 0 ~ "↑",
                                .default = "-"),
           sig_diff_tooltip = case_when(sig_diff != "-" & pct > all_bham_pct ~ "Sig. higher than Birmingham average",
                                        sig_diff != "-" & pct < all_bham_pct ~ "Sig. lower than Birmingham average",
                                        .default = "Similar to Birmingham average")) |>
    mutate(sig_diff_tooltip = paste0(sig_diff_tooltip, " (", round(all_bham_pct, 2), "%)")) |> 
    mutate(text = case_when(count <= suppression_value ~ "Too small",
                            .default = paste0(round(pct, 2), "%", "\n", sig_diff))) |> 
    mutate(pct = case_when(count <= suppression_value ~ NA_real_,
                           .default = pct)) |> 
    mutate(text_colour = case_when(pct >= white_text_threshold ~ "white",
                                   .default = "black")) |> 
    mutate(tooltip = case_when(count > suppression_value ~ paste0("IDACI Quintile ", IDACI_2019_Quintile, "\n",
                                                                  Ethnicity, "\n",
                                                                  round(pct, 2), "% ", BMI_Category, "\n",
                                                                  count, " children", "\n",
                                                                  sig_diff_tooltip),
                               count <= suppression_value ~ paste0("IDACI Quintile ", IDACI_2019_Quintile, "\n",
                                                                   Ethnicity, "\n",
                                                                   "Data suppressed"))) |> 
    mutate(IDACI_2019_Quintile = factor(IDACI_2019_Quintile,
                                        levels = c("3-5", "2", "1"))) |> 
    ggplot() +
    ggiraph::geom_tile_interactive(aes(x = Ethnicity,
                                       y = IDACI_2019_Quintile,
                                       fill = pct,
                                       tooltip = tooltip),
                                   colour = "white") +
    geom_text(aes(x = Ethnicity,
                  y = IDACI_2019_Quintile,
                  label = text,
                  color = text_colour)) +
    scale_fill_distiller(palette = "Purples",
                         direction = 1,
                         na.value = "lightgrey") +
    scale_colour_manual(values = c("black", "white")) +
    theme_classic() +
    theme(legend.position="none",
          panel.spacing = unit(0, "pt"),
          plot.margin = unit(c(0,0,0,0), 'lines')) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_discrete(expand = c(0, 0)) +
    xlab("Ethnicity") +
    ylab("IDACI Quintile")
  
  df_md_top_bars <- df |> 
    filter(Year == year,
           School_Year == school_year) |>
    group_by(BMI_Category, Ethnicity) |> 
    count(name = "count") |> 
    ungroup() |> 
    group_by(Ethnicity) |> 
    mutate(denominator = sum(count)) |> 
    filter(BMI_Category == category)
  
  df_md_top_bars <- wilson_ci(df_md_top_bars,
                              df_md_top_bars$count,
                              df_md_top_bars$denominator)
  
  top_bars <- df_md_top_bars |>
    mutate(tooltip = paste0(Ethnicity, "\n",
                            category, "\n",
                            round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)")) |> 
    ggplot(aes(x = Ethnicity,
               y = pct)) +
    ggiraph::geom_col_interactive(aes(tooltip = tooltip),
                                  fill = "#807dba") +
    geom_errorbar(aes(ymin = lower_ci,
                      ymax = upper_ci),
                  position = position_dodge(width = 0.9),
                  width = 0.2) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_continuous(expand = expansion(mult = c(0, 0.15)),
                       labels = scales::label_percent(scale = 1)) +
    theme_classic() +
    theme(legend.position="none",
          panel.spacing = unit(0, "pt"),
          axis.text.x = element_blank(),
          #axis.title.x = element_blank(),
          axis.ticks.x = element_blank(),
          # axis.line.y = element_line(colour = "black",
          #                            linewidth = 1),
          plot.margin = unit(c(0,0,0,0), 'lines')) +
    xlab("") +
    ylab(paste0(category, " % \n(", school_year, ")"))
  
  df_md_side_bars <- df |> 
    filter(Year == year,
           School_Year == school_year) |>
    group_by(BMI_Category, IDACI_2019_Quintile) |> 
    count(name = "count") |> 
    ungroup() |> 
    group_by(IDACI_2019_Quintile) |> 
    mutate(denominator = sum(count)) |> 
    filter(BMI_Category == category)
  
  df_md_side_bars <- wilson_ci(df_md_side_bars,
                               df_md_side_bars$count,
                               df_md_side_bars$denominator)
  
  side_bars <- df_md_side_bars |>
    mutate(IDACI_2019_Quintile = factor(IDACI_2019_Quintile,
                                        levels = c("3-5", "2", "1"))) |>
    mutate(tooltip = paste0("IDACI Quintile ",IDACI_2019_Quintile, "\n",
                            category, "\n",
                            round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)")) |> 
    ggplot(aes(x = pct,
               y = IDACI_2019_Quintile)) +
    ggiraph::geom_col_interactive(aes(tooltip = tooltip),
                                  fill = "#807dba") +
    geom_errorbar(aes(xmin = lower_ci,
                      xmax = upper_ci),
                  position = position_dodge(width = 0.9),
                  width = 0.2) +
    scale_y_discrete(expand = c(0, 0)) +
    scale_x_continuous(expand = expansion(mult = c(0, 0.15)),
                       labels = scales::label_percent(scale = 1)) +
    theme_classic() +
    theme(legend.position="none",
          panel.spacing = unit(0, "pt"),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          # axis.line.y = element_line(colour = "black",
          #                            linewidth = 1),
          plot.margin = unit(c(0,0,0,0), 'lines')) +
    ylab("") +
    xlab(paste0(category, " % \n(", school_year, ")"))
  
  empty_plot <- ggplot(df_md) +
    geom_blank()+
    theme_minimal()+
    coord_flip()+
    theme(axis.text.y = element_blank(),
          axis.title.y = element_blank(),
          axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          legend.position="none",
          plot.margin = unit(c(0,0,0,0), 'lines'))
  
  all_plots <- top_bars + empty_plot + heatmap + side_bars + plot_layout(widths = c(3, 1),
                                                                         heights = c(1, 3))
  ggiraph::girafe(ggobj = all_plots)
}
```

```{r data_import}
#| output: false
#| warning: false
# create connection to SQL server
conpool <- pool::dbPool(drv = odbc::odbc(), Driver="SQL Server", Server="SVWVSQ016\\SVWVSQ016", Database="PH_Evelyn", Trusted_Connection="True")           # ie setting up an ODBC connection to SQL Server.

# NCMP data from SQL
# Create a string variable containing SQL string
str_SQL_Code_NCMP <- "/****** Script for SelectTopNRows command from SSMS  ******/
SELECT o.[SchoolYear] AS Year
      ,o.[DoH_URN]
      ,o.[School_Year]
      ,o.[Gender]
      ,o.[DateofBirth] AS DOB
      ,o.[PostcodeofPupil]
      ,o.[DateofMeasurement]
      ,o.[Height_z]
      ,o.[Height_p]
      ,o.[Weight_z]
      ,o.[Weight_p]
      ,o.[BMI score]
      ,o.[BMI_z]
      ,o.[BMI_p]
      ,o.[Ethnic Description] AS Ethnicity
      ,o.[NCMPSystemId]
      ,o.[PupilReference]
      ,o.[NHSEthnicDescription] AS NHS_Ethnicity
      ,o.[ClinicalBMIcategory] AS BMI_Category_Clinical
      ,o.[GroupedClinicalBMIcategory] AS BMI_Category_Clinical_Grouped
      ,o.[PopulationBMIcategory] AS BMI_Category
      ,o.[GroupedPopulationBMIcategory] AS BMI_Category_Grouped
      ,o.[NonMeasurementReasonDescription]
      ,o.[PupilIndexOfMultipleDeprivationScore] AS Pupil_IMD_Score
      ,o.[PupilIndexOfMultipleDeprivationDecile] AS Pupil_IMD_Decile
      ,o.[ExtremeBmiWarning]
      ,p.[2011 Lower Layer Super Output Area] AS LSOA11CD
	    ,p.[2021 Lower Layer Super Output Area] AS LSOA21CD
	    ,p.[2021 Middle Layer Super Output Area] AS MSOA21CD
	    ,p.[2018 Ward code] AS WD18CD
	    ,w.[2018 Ward Name] AS WD18NM
	    ,p.[Westminster Parliamentary constituency]
  FROM [PH_Obesity].[dbo].[tblMainTable] AS o
  INNER JOIN [PH_LookUps].[dbo].[vw_tblNWWMClusterFullPostcodeFile] AS p
  ON o.[PostcodeofPupil] = p.[Postcod8] COLLATE SQL_Latin1_General_CP1_CI_AS
  INNER JOIN [PH_LookUps].[dbo].[tlkpWardNames2018byBham] as w
  ON p.[2018 Ward code] = w.[2018 Ward Code]
  WHERE o.[SchoolYear] BETWEEN '2013/2014' AND '2023/2024'"

ncmp_data <- DBI::dbGetQuery(conpool, str_SQL_Code_NCMP)  # ie import the sql table into R as a dataframe

# import IDACI quintiles
IDACI_quintiles <- read_excel("//svwvap1126/phsensitive$/Intelligence New/Themes/Deprivation/IMD/IMD 2019/File_3_-_IoD2019_Supplementary_Indices_-_IDACI_and_IDAOPI.xlsx",
                              sheet = "IoD2019 IDACI & IDAOPI") |> 
  filter(`Local Authority District code (2019)` == "E08000025") |> 
  select(`LSOA code (2011)`, `Income Deprivation Affecting Children Index (IDACI) Decile (where 1 is most deprived 10% of LSOAs)`) |> 
  rename(LSOA11CD = `LSOA code (2011)`,
         IDACI_2019_Decile = `Income Deprivation Affecting Children Index (IDACI) Decile (where 1 is most deprived 10% of LSOAs)`) |> 
  mutate(IDACI_2019_Quintile = case_when(IDACI_2019_Decile <= 2 ~ 1,
                                        IDACI_2019_Decile <= 4 ~ 2,
                                        IDACI_2019_Decile <= 6 ~ 3,
                                        IDACI_2019_Decile <= 8 ~ 4,
                                        IDACI_2019_Decile <= 10 ~ 5))


# Main dataset cleaning and manipulation ----------------------------------

# add IDACI decile and quintile by merging on LSOA11CD
ncmp_data <- ncmp_data |> 
  left_join(IDACI_quintiles,
            by = "LSOA11CD")

# put non-measurement rows into own df
no_measurement <- ncmp_data |> 
  filter(NonMeasurementReasonDescription != "" | is.na(BMI_Category))

# filter non-measurement rows out of main df
ncmp_data <- ncmp_data |> 
  filter(!is.na(BMI_Category))

# change values in some fields
ncmp_data <- ncmp_data |> 
  mutate(Gender = case_when(Gender == "M" ~ "Male",
                            Gender == "F" ~ "Female"),
         School_Year = case_when(School_Year == "Year 0" ~ "Reception",
                                 School_Year == "Year 6" ~ "Year 6"),
         BMI_Category = case_when(BMI_Category == "underweight" ~ "Underweight",
                                  BMI_Category == "healthy weight" ~ "Healthy Weight",
                                  BMI_Category == "overweight" ~ "Overweight",
                                  BMI_Category == "very overweight" ~ "Obese"),
         BMI_Category_Grouped = case_when(BMI_Category_Grouped == "underweight" ~ "Underweight",
                                          BMI_Category_Grouped == "healthy weight" ~ "Healthy Weight",
                                          BMI_Category_Grouped == "overweight or very overweight" ~ "Overweight/Obese"),
         BMI_Category_Clinical = case_when(BMI_Category_Clinical == "underweight" ~ "Underweight",
                                           BMI_Category_Clinical == "healthy weight" ~ "Healthy Weight",
                                           BMI_Category_Clinical == "overweight" ~ "Overweight",
                                           BMI_Category_Clinical == "very overweight" ~ "Obese"),
         BMI_Category_Clinical_Grouped = case_when(BMI_Category_Clinical_Grouped == "underweight" ~ "Underweight",
                                                   BMI_Category_Clinical_Grouped == "healthy weight" ~ "Healthy Weight",
                                                   BMI_Category_Clinical_Grouped == "overweight or very overweight" ~ "Overweight/Obese"))

# merge/rename some ethnicities to give Asian, Black, Mixed, Unknown, White, Other
ncmp_data <- ncmp_data |> 
  mutate(Ethnicity = case_when(is.na(Ethnicity) ~ "Unknown",
                               Ethnicity == "Chinese" ~ "Asian",
                               Ethnicity == "Not stated" ~ "Unknown",
                               Ethnicity == "Any other ethnic group" ~ "Other",
                               .default = Ethnicity)) |> 
  mutate(Ethnicity = str_trim(Ethnicity))

# factorise imd scores
ncmp_data <- ncmp_data |> 
  mutate(IDACI_2019_Decile = factor(IDACI_2019_Decile,
                                    levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10")),
         IDACI_2019_Quintile = factor(IDACI_2019_Quintile,
                                      levels = c("1", "2", "3", "4", "5")))

# add short stature column based on height_p
# need to calculate height_p using height_z for 2013/14 and 2014/15
ncmp_data <- ncmp_data |>
  mutate(Height_p = case_when(Year == "2013/2014" ~ pnorm(Height_z),
                              Year == "2014/2015" ~ pnorm(Height_z),
                              .default = Height_p),
         short_stature = case_when(Height_p <= 0.02 ~ TRUE,
                                   .default = FALSE))

# put years into a vector
years <- unique(ncmp_data$Year)

# remove 2020/2021
years <- years[!years %in% c("2020/2021")]

# create df with three years of data (first three years i.e. oldest)
ncmp_data_period_1 <- ncmp_data |> 
  filter(Year == years[1]|Year == years[2]|Year == years[3]) |> 
  mutate(Year = paste0(sub("(20)(.*?)(20)", "\\1\\2", years[1]), " to ", sub("(20)(.*?)(20)", "\\1\\2", years[3])))

# same again but with next three year period
ncmp_data_period_2 <- ncmp_data |> 
  filter(Year == years[2]|Year == years[3]|Year == years[4]) |> 
  mutate(Year = paste0(sub("(20)(.*?)(20)", "\\1\\2", years[2]), " to ", sub("(20)(.*?)(20)", "\\1\\2", years[4])))

# and so on
ncmp_data_period_3 <- ncmp_data |> 
  filter(Year == years[3]|Year == years[4]|Year == years[5]) |> 
  mutate(Year = paste0(sub("(20)(.*?)(20)", "\\1\\2", years[3]), " to ", sub("(20)(.*?)(20)", "\\1\\2", years[5])))

ncmp_data_period_4 <- ncmp_data |> 
  filter(Year == years[4]|Year == years[5]|Year == years[6]) |> 
  mutate(Year = paste0(sub("(20)(.*?)(20)", "\\1\\2", years[4]), " to ", sub("(20)(.*?)(20)", "\\1\\2", years[6])))

ncmp_data_period_5 <- ncmp_data |> 
  filter(Year == years[5]|Year == years[6]|Year == years[7]) |> 
  mutate(Year = paste0(sub("(20)(.*?)(20)", "\\1\\2", years[5]), " to ", sub("(20)(.*?)(20)", "\\1\\2", years[7])))

ncmp_data_period_6 <- ncmp_data |> 
  filter(Year == years[6]|Year == years[7]|Year == years[8]) |> 
  mutate(Year = paste0(sub("(20)(.*?)(20)", "\\1\\2", years[6]), " to ", sub("(20)(.*?)(20)", "\\1\\2", years[8])))

ncmp_data_period_7 <- ncmp_data |> 
  filter(Year == years[7]|Year == years[8]|Year == years[9]) |> 
  mutate(Year = paste0(sub("(20)(.*?)(20)", "\\1\\2", years[7]), " to ", sub("(20)(.*?)(20)", "\\1\\2", years[9])))

# most recent period
ncmp_data_period_8 <- ncmp_data |> 
  filter(Year == years[8]|Year == years[9]|Year == years[10]) |> 
  mutate(Year = paste0(sub("(20)(.*?)(20)", "\\1\\2", years[8]), " to ", sub("(20)(.*?)(20)", "\\1\\2", years[10])))

# bind all into one df
ncmp_data_3_years_combined <- bind_rows(ncmp_data_period_1,
                                        ncmp_data_period_2,
                                        ncmp_data_period_3,
                                        ncmp_data_period_4,
                                        ncmp_data_period_5,
                                        ncmp_data_period_6,
                                        ncmp_data_period_7,
                                        ncmp_data_period_8)

periods <- unique(ncmp_data_3_years_combined$Year)

# get a list of periods in format 20XX-XX
# where most recent period is periods[8]
periods_short <- sub("/([A-Za-z0-9]+( [A-Za-z0-9]+)+)/", "-", unique(ncmp_data_3_years_combined$Year))

# load participation info list
load("../data/participation_info.rda")

# extract values from list
fingertips_reception_participants <- participation_info$fingertips_reception_participants
fingertips_reception_participation <- participation_info$fingertips_reception_participation
data_reception_participants <- participation_info$data_reception_participants
fingertips_y6_participants <- participation_info$fingertips_y6_participants
fingertips_y6_participation <- participation_info$fingertips_y6_participation
data_y6_participants <- participation_info$data_y6_participants

# calculate number of overweight/obese children in birmingham by school year, and calculate denominator (children per school year) (for period 2021-2024)
obese_overweight_all_birmingham_by_school_year <- ncmp_data_period_8 |> 
  mutate(BMI_Category = case_when(BMI_Category == "Obese" ~ "Overweight/Obese",
                                  BMI_Category == "Overweight" ~ "Overweight/Obese",
                                  .default = BMI_Category)) |> 
  group_by(BMI_Category, School_Year) |> 
  count(name = "count") |> 
  ungroup() |> 
  group_by(School_Year) |> 
  mutate(denominator = sum(count)) |> 
  filter(BMI_Category == "Overweight/Obese")


# calculate % of overweight/obese incl confidence intervals
obese_overweight_all_birmingham_by_school_year <- wilson_ci(obese_overweight_all_birmingham_by_school_year,
                                                           obese_overweight_all_birmingham_by_school_year$count,
                                                           obese_overweight_all_birmingham_by_school_year$denominator)

obese_overweight_all_birmingham_r_pct <- obese_overweight_all_birmingham_by_school_year$pct[1]
obese_overweight_all_birmingham_y6_pct <- obese_overweight_all_birmingham_by_school_year$pct[2]
obese_overweight_all_birmingham_r_lower_ci <- obese_overweight_all_birmingham_by_school_year$lower_ci[1]
obese_overweight_all_birmingham_r_upper_ci <- obese_overweight_all_birmingham_by_school_year$upper_ci[1]
obese_overweight_all_birmingham_y6_lower_ci <- obese_overweight_all_birmingham_by_school_year$lower_ci[2]
obese_overweight_all_birmingham_y6_upper_ci <- obese_overweight_all_birmingham_by_school_year$upper_ci[2]
```

```{r england_data_import}
#| output: false
#| warning: false

load("../data/england_data_3_years_combined.rda")
```

This report was produced by Birmingham Public Health (Knowledge Team). For support or feedback please contact publichealthintelligence\@birmingham.gov.uk

# Main Messages

This report presents analysis of data from the National Child Measurement Program (NCMP) for children in Birmingham. The majority of analyses combine the 3 most recent annual cohorts of NCMP data (`{r} years[8]`, `{r} years[9]` and `{r} years[10]`) to ensure results are robust.

In summary, deprivation, ethnicity and gender all have varying levels of impact on the prevalence of overweight and obesity. The effect of deprivation is the simplest - prevalence of obesity is highest in the most deprived areas of Birmingham. Ethnicity and gender also affect prevalence in more complex ways, described below.

In Reception-age children:

-   Prevalence of overweight and obesity has decreased significantly in Birmingham between the 2013-16 and 2021-24 periods (from a high of 24.1% in the 2016-19 period to 22.4% in the 2021-24 period).
-   In the most recent three-year period, prevalence of overweight and obesity is significantly higher in Birmingham (22.4%) when compared to the England average (21.9%).
-   Children of both genders who live in the most deprived areas have significantly higher prevalence of overweight and obesity (23.6%) compared to children who live in the least deprived areas (16.1%).
-   Asian children have significantly lower prevalence of overweight and obesity (19.9%) than White (25.0%), Black (24.3%) and Mixed ethnicity (25.1%) children (all of whom have similar prevalence).
-   Asian children have significantly higher prevalence of underweight (3.0%) than children of Black (1.5%), Mixed (1.2%) and Other (1.5%) ethnicities. White children have significantly lower prevalence of underweight (0.6%) than all other ethnicities.
-   Prevalence of short stature is significantly higher in girls (1.9%) than boys (1.5%), and is lowest in Black and Mixed ethnicity children.

In Year 6-age children:

-   Prevalence of overweight and obesity has significantly increased in Birmingham between the 2013-16 and 2021-24 periods (from 39.4% to 41.3%).
-   In the most recent three-year period, prevalence of overweight and obesity is significantly higher in Birmingham (41.3%) when compared to the England average (36.7%).
-   Children of both genders who live in the most deprived areas have significantly higher prevalence of overweight and obesity (43.5%) compared to children who live in the least deprived areas (27.9%).
-   Asian (42.6%), Black (43.6%) and Mixed ethnicity (42.6%) children have significantly higher prevalence of overweight and obesity than White children (38.9%).
-   Asian children have significantly higher prevalence of underweight (3.5%) than children of all other ethnicities (Black: 1.8%; Mixed:1.4%; Other: 2.2%; White: 1.2%). Prevalence in White children is significantly lower than in Black or Mixed ethnicity children.
-   Prevalence of short stature has decreased significantly between the 2013-6 (1.4%) and 2021-24 (0.9%) periods, with Black children having lowest prevalence.

# Introduction

Welcome to this analysis report for the National Child Measurement Program (NCMP). The NCMP is essential for monitoring the prevalence of overweight and obesity in children, both in Birmingham and nationally. It also provides insights into the prevalence of short stature. Children are measured each year in Reception (aged 4-5 years) and Year 6 (aged 10-11 years).

The majority of the analysis in this report combines data from the past three years (`{r} years[8]`, `{r} years[9]` and `{r} years[10]`) to give a three-year-combined period (`{r} periods_short[8]`). This improves data robustness and allows more concrete conclusions to be drawn. Where time series are plotted, three-year periods are also used. Data from the 2020/21 academic year has not been used due to very low participation rates as a result of the Covid-19 pandemic.

## Data Suppression

In some instances, data has been suppressed in accordance with [NHS Digital disclosure control](https://digital.nhs.uk/data-and-information/find-data-and-publications/statement-of-administrative-sources/methodological-changes/changes-to-the-national-child-measurement-programme-2019-20-publication-content-and-disclosure-control-methodology) recommendations:

-   Any value based on a numerator of 7 or less has been suppressed
-   Percentages and rates have been calculated using rounded data (e.g. the numerator and denominator for a percentage have been rounded to the nearest 5).

## Participation

In the `{r} periods_short[8]` period, an average of `{r} round(fingertips_reception_participation, 1)`% of eligible Reception pupils (`{r} as.integer(fingertips_reception_participants)` children total) and an average of `{r} round(fingertips_y6_participation, 1)`% of eligible Year 6 pupils (`{r} as.integer(fingertips_y6_participants)` children total) in Birmingham were measured as part of the NCMP.

## Confidence intervals

Where possible, 95% confidence intervals have been included. All summary statistics have a degree of uncertainty and confidence intervals help visualise this. 95 times out of 100, the true value will fall somewhere within the range given by the confidence intervals.

Confidence intervals are displayed as one or both of:

-   error bars on a chart, showing the upper and lower limits of the range
-   a range in the tooltip of a chart (e.g. 45.1% (43.2 - 46.3%) means the calculated value is 45.1%, with an upper confidence interval of 43.2% and a lower interval of 46.3%.)

In the written commentary in this report, comparisons between groups and over time have been statistically tested to determine whether differences are likely to be genuine (i.e. statistically significant) or the result of random natural variation. Only statistically significant differences have been described with terms such as “higher”, “lower”, “increase” or “decrease”. Where non-significant differences are described they are clearly marked.

# Prevalence of Overweight and Obesity

It has been well-understood for many years that children who are overweight or obese are more likely to become overweight or obese adults, and that the probability of this increases with age[^1]. Overweight and obesity in adulthood is associated with multiple health conditions, and places a significant burden on health services.

[^1]: Serdula MK, Ivery D, Coates RJ, Freedman DS, Williamson DF, Byers T. Do obese children become obese adults? A review of the literature. Preventative Medicine 1993

This section of the report investigates the prevalence of overweight and obesity (and, where relevant, underweight) in children in Birmingham, and the socioeconomic and demographic factors influencing this.

BMI thresholds for children are assigned based on the British 1990 Growth Reference (UK90), which describes the expected pattern of growth for children at different ages and by sex.

At a population level, BMI categories are assigned as such:

-   **Underweight:** BMI less than the 2nd centile of the UK90 according to age and sex
-   **Healthy weight:** BMI between the 2nd and 85th centiles
-   **Overweight:** BMI between the 85th and 95th centiles
-   **Obese:** BMI on or above the 95th centile

## Overview

This section looks at Birmingham as a whole, providing a broad overview of how the city is performing. It also compares Birmingham to England.

### BMI Category breakdown

**Figure 1. Percentage of children in each BMI category, by school year (`{r} periods_short[8]` period)**

The proportion of children who are obese is much higher (more than double) in Year 6 than in Reception. Prevalence of overweight is also higher in Year 6 children, as is prevalence of underweight.

```{r bmi_cat_year_group}
#| warning: false
# count how many children fall into each bmi category by school year by 3 year period
bmi_category_by_school_year_by_3yrs <- ncmp_data_3_years_combined |> 
  group_by(BMI_Category, School_Year, Year) |> 
  count(name = "count") |> 
  ungroup() |> 
  group_by(School_Year, Year) |> 
  mutate(denominator = sum(count))

# count obese and overweight as one category
bmi_category_by_school_year_by_3yrs_oo <- ncmp_data_3_years_combined |> 
  mutate(BMI_Category = case_when(BMI_Category == "Obese" ~ "Overweight/Obese",
                                  BMI_Category == "Overweight" ~ "Overweight/Obese",
                                  .default = BMI_Category)) |> 
  group_by(BMI_Category, School_Year, Year) |> 
  count(name = "count") |> 
  ungroup() |> 
  group_by(School_Year, Year) |> 
  mutate(denominator = sum(count)) |> 
  filter(BMI_Category == "Overweight/Obese")

# combine overweight/obese with main df
bmi_category_by_school_year_by_3yrs <- rbind(bmi_category_by_school_year_by_3yrs,
                                             bmi_category_by_school_year_by_3yrs_oo)

# add percentage and ci
bmi_category_by_school_year_by_3yrs <- wilson_ci(bmi_category_by_school_year_by_3yrs,
                                               bmi_category_by_school_year_by_3yrs$count,
                                               bmi_category_by_school_year_by_3yrs$denominator)

# stacked bars for 21-24
graph <- bmi_category_by_school_year_by_3yrs |> 
  filter(Year == periods[8]) |> 
  filter(BMI_Category != "Overweight/Obese") |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(BMI_Category = factor(BMI_Category,
                               levels = c("Obese", "Overweight", "Healthy Weight", "Underweight"))) |> 
  mutate(tooltip = paste0(School_Year, "\n",
                          BMI_Category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)")) |>
  ggplot(aes(y = School_Year, 
             x = pct,
             fill = BMI_Category,
             tooltip = tooltip)) +
  geom_col_interactive() +
  theme_classic() +
  scale_x_continuous(expand = c(0,0),
                     label = scales::label_percent(scale = 1),
                     name = "Percentage of children") +
  scale_y_discrete(name = "School Year") +
  scale_fill_manual(values = c(bcc_colours[4:2], bcc_colours[5]),
                    name = "BMI Category")

girafe(ggobj = graph)
```

### Prevalence of overweight/obesity, compared to England

**Figure 2. Prevalence of overweight and obesity in Birmingham and England, by school year (`{r} periods_short[8]` period)**

Birmingham has higher levels of overweight and obesity than the England average for both Reception and Year 6 pupils.

```{r oo_year_group}
#| warning: false
# overweight/obese 2021-24, compared to England

graph <- bmi_category_by_school_year_by_3yrs |> 
  mutate(geography = "Birmingham") |> 
  rbind(england_data_3_years_combined) |>
  mutate(lower_ci = case_when(geography == "England" ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(geography == "England" ~ NA_real_,
                              .default = upper_ci)) |> 
  filter(BMI_Category == "Overweight/Obese",
         Year == periods[8]) |> 
  mutate(tooltip_ci = case_when(geography == "England" ~ "%",
                                geography == "Birmingham" ~ paste0("% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)"))) |> 
  mutate(tooltip = paste0(geography, "\n",
                          School_Year, "\n",
                          round(pct, 1), tooltip_ci)) |> 
  ggplot(aes(x = School_Year,
             y = pct,
             fill = geography)) +
  geom_col_interactive(aes(tooltip = tooltip),
                       position = "dodge") +
  geom_errorbar(aes(ymin = lower_ci,
                    ymax = upper_ci),
                position = position_dodge(width = 0.9),
                width = 0.2) +
  theme_classic() +
  scale_x_discrete(name = "School Year") +
  scale_y_continuous(expand = c(0,0),
                     name = "Percentage of children\n overweight/obese",
                     labels = scales::label_percent(scale = 1)) +
  scale_fill_manual(values = bcc_colours,
                      name = "Geography")

girafe(ggobj = graph)
```

### Prevalence of overweight/obesity, compared to England, over time

Figures 3a and 3b show the prevalence of overweight and obesity in Birmingham and England over time, split by school year. Use the tabs to move between the figures.

::: panel-tabset
## Reception

**Figure 3a. Percentage of Reception children who are overweight or obese over time, compared to England**

Prevalence of overweight and obesity has decreased in Birmingham since 2013-16. Birmingham continues to have higher prevalence than the England average, although the gap has got smaller and during the 2019-23 combined period Birmingham had similar prevalence to England for the first time.

```{r oo_over_time_r}
#| warning: false
graph <- bmi_category_by_school_year_by_3yrs |> 
  mutate(geography = "Birmingham") |> 
  rbind(england_data_3_years_combined) |> 
  filter(BMI_Category == "Overweight/Obese",
         School_Year == "Reception") |> 
  mutate(lower_ci = case_when(geography == "England" ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(geography == "England" ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(tooltip_ci = case_when(geography == "England" ~ "%",
                                geography == "Birmingham" ~ paste0("% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)"))) |> 
  mutate(tooltip = paste0(geography, "\n",
                          Year, "\n",
                          School_Year, "\n",
                          round(pct, 1), tooltip_ci)) |>
  ggplot(aes(x = Year,
             y = pct,
             colour = geography)) +
  geom_point_interactive(aes(tooltip = tooltip),
                         #col = "white"
                         size = 2) +
  geom_line_interactive(aes(group = geography)) +
  geom_errorbar(aes(ymin = lower_ci,
                    ymax = upper_ci),
                width = 0.2) +
  theme_classic() +
  scale_x_discrete(name = "Year") +
  scale_y_continuous(name = "Percentage of children\n overweight/obese",
                     labels = scales::label_percent(scale = 1)) +
  scale_colour_manual(values = bcc_colours,
                      name = "Geography") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

girafe(ggobj = graph)
```

## Year 6

**Figure 3b. Percentage of Year 6 children who are overweight or obese over time, compared to England**

Prevalence of overweight and obesity has increased in Birmingham since 2013-16, following a trend similar to England. Birmingham continues to have higher prevalence than the England average, although the gap has got smaller.

```{r oo_over_time_y6}
#| warning: false
graph <- bmi_category_by_school_year_by_3yrs |> 
  mutate(geography = "Birmingham") |> 
  rbind(england_data_3_years_combined) |> 
  filter(BMI_Category == "Overweight/Obese",
         School_Year == "Year 6") |> 
  mutate(lower_ci = case_when(geography == "England" ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(geography == "England" ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(tooltip_ci = case_when(geography == "England" ~ "%",
                                geography == "Birmingham" ~ paste0("% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)"))) |> 
  mutate(tooltip = paste0(geography, "\n",
                          Year, "\n",
                          School_Year, "\n",
                          round(pct, 1), tooltip_ci)) |>
  ggplot(aes(x = Year,
             y = pct,
             colour = geography)) +
  geom_point_interactive(aes(tooltip = tooltip),
                         #col = "white"
                         size = 2) +
  geom_line_interactive(aes(group = geography)) +
  geom_errorbar(aes(ymin = lower_ci,
                    ymax = upper_ci),
                width = 0.2) +
  theme_classic() +
  scale_x_discrete(name = "Year") +
  scale_y_continuous(name = "Percentage of children\n overweight/obese",
                     labels = scales::label_percent(scale = 1)) +
  scale_colour_manual(values = bcc_colours,
                      name = "Geography") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

girafe(ggobj = graph)
```
:::

## By Deprivation

This section investigates the effect of deprivation on BMI category. There is a strong correlation between obesity and deprivation, with children living in the most deprived areas experiencing a higher prevalence of obesity than their less deprived peers[^2].

[^2]: NHS Digital, National Child Measurement Programme, England, 2023/24

Deprivation is measured here using the Income Deprivation Affecting Children Index (IDACI), which measures the proportion of children aged 0-15 living in income-deprived families in a small, defined area. These small areas are divided according to their deprivation rank into five quintiles, ranging from the most deprived areas (IDACI quintile 1) to the least deprived areas (IDACI quintile 5). IDACI quintile is calculated using the postcode of a child's home address.

::: callout-warning
## Important Note

It is important to note that the majority (over 60%) of children included in this analysis are classed as living in IDACI quintile 1, while only around 4% live in quintile 5. As a result, the sample sizes for quintiles 3, 4 and 5 are relatively small, meaning confidence intervals are generally large and statistical significance is harder to achieve. This should be taken into account when e.g. considering changes over time or comparing groups.
:::

### BMI Category by IDACI Quintile

```{r bmi_cat_idaci_setup}
#| warning: false
bmi_category_by_school_year_by_idaci <- ncmp_data_period_8 |> 
  group_by(School_Year, IDACI_2019_Quintile, BMI_Category) |>
  count(name = "count") |> 
  ungroup() |> 
  group_by(School_Year, IDACI_2019_Quintile) |> 
  mutate(denominator = sum(count))

bmi_category_by_school_year_by_idaci <- wilson_ci(bmi_category_by_school_year_by_idaci,
                                                        bmi_category_by_school_year_by_idaci$count,
                                                        bmi_category_by_school_year_by_idaci$denominator)
```

Figures 4a and 4b show the percentage of children in each IDACI quintile who fall into each of the four BMI categories (underweight, healthy weight, overweight and obese), for the 3-year period `{r} periods_short[8]`. Use the tabs to move between the figures.

::: panel-tabset
## Reception

**Figure 4a. Percentage of Reception children in each BMI category by IDACI quintile**

Prevalence of obesity increases as deprivation increases, while prevalence of overweight and underweight are roughly similar at each quintile.

```{r bmi_cat_idaci_r}
#| warning: false
graph <- bmi_category_by_school_year_by_idaci |> 
  filter(School_Year == "Reception") |> 
  mutate(tooltip = paste0("IDACI Quintile ",IDACI_2019_Quintile, "\n", 
                          BMI_Category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n")) |> 
  mutate(BMI_Category = factor(BMI_Category,
                               levels = c("Obese", "Overweight", "Healthy Weight", "Underweight"))) |> 
  mutate(IDACI_2019_Quintile = case_when(IDACI_2019_Quintile == "5" ~ "5\n(least deprived)",
                                         IDACI_2019_Quintile == "1" ~ "1\n(most deprived)",
                                         .default = IDACI_2019_Quintile)) |> 
  mutate(IDACI_2019_Quintile = factor(IDACI_2019_Quintile,
                                      levels = c("5\n(least deprived)",
                                                 "4",
                                                 "3",
                                                 "2",
                                                 "1\n(most deprived)"))) |> 
  ggplot(aes(x = pct, 
             y = IDACI_2019_Quintile)) +
  geom_col_interactive(aes(fill = BMI_Category,
                           tooltip = tooltip)) +
  scale_fill_manual(values = c(bcc_colours[4:2], bcc_colours[5])) +
  scale_colour_manual(values = c("black", "white")) +
  theme_minimal() +
  scale_x_continuous(expand = c(0,0),
                     label = scales::label_percent(scale = 1),
                     name = "Percentage of children") +
  scale_y_discrete(name = "IDACI Quintile") +
  guides(fill = guide_legend(reverse = T,
                             title = "BMI Category"),
         colour = "none")

girafe(ggobj = graph)
```

## Year 6

**Figure 4a. Percentage of Year 6 children in each BMI category by IDACI quintile**

Prevalence of obesity increases as deprivation increases, while prevalence of overweight and underweight are roughly similar at each quintile.

```{r bmi_cat_idaci_y6}
#| warning: false
graph <- bmi_category_by_school_year_by_idaci |> 
  filter(School_Year == "Year 6") |> 
  mutate(tooltip = paste0("IDACI Quintile ",IDACI_2019_Quintile, "\n", 
                          BMI_Category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n")) |> 
  mutate(BMI_Category = factor(BMI_Category,
                               levels = c("Obese", "Overweight", "Healthy Weight", "Underweight"))) |> 
  mutate(IDACI_2019_Quintile = case_when(IDACI_2019_Quintile == "5" ~ "5\n(least deprived)",
                                         IDACI_2019_Quintile == "1" ~ "1\n(most deprived)",
                                         .default = IDACI_2019_Quintile)) |> 
  mutate(IDACI_2019_Quintile = factor(IDACI_2019_Quintile,
                                      levels = c("5\n(least deprived)",
                                                 "4",
                                                 "3",
                                                 "2",
                                                 "1\n(most deprived)"))) |> 
  ggplot(aes(x = pct, 
             y = IDACI_2019_Quintile)) +
  geom_col_interactive(aes(fill = BMI_Category,
                           tooltip = tooltip)) +
  scale_fill_manual(values = c(bcc_colours[4:2], bcc_colours[5])) +
  scale_colour_manual(values = c("black", "white")) +
  theme_minimal() +
  scale_x_continuous(expand = c(0,0),
                     label = scales::label_percent(scale = 1),
                     name = "Percentage of children") +
  scale_y_discrete(name = "IDACI Quintile") +
  guides(fill = guide_legend(reverse = T,
                             title = "BMI Category"),
         colour = "none")

girafe(ggobj = graph)
```
:::

### Overweight/Obese by IDACI Quintile and Gender

```{r obese_overweight_idaci_gender_setup}
#| warning: false

data_md_gender_idaci_overweight_obese <- ncmp_data_period_8 |> 
  mutate(BMI_Category = case_when(BMI_Category == "Obese" ~ "Overweight/Obese",
                                  BMI_Category == "Overweight" ~ "Overweight/Obese",
                                  .default = BMI_Category)) |> 
  group_by(School_Year, Gender, IDACI_2019_Quintile, BMI_Category) |> 
  count() |> 
  ungroup() |> 
  group_by(School_Year, Gender, IDACI_2019_Quintile) |> 
  mutate(denominator = sum(n)) |> 
  rename(count = n) |> 
  filter(BMI_Category == "Overweight/Obese")

data_md_gender_idaci_overweight_obese <-  wilson_ci(data_md_gender_idaci_overweight_obese,
                                                              data_md_gender_idaci_overweight_obese$count,
                                                              data_md_gender_idaci_overweight_obese$denominator)
```

Figures 5a and 5b show the percentage of girls and boys in each IDACI quintile who are classed as either overweight or obese, for the 3-year period `{r} periods_short[8]`. Use the tabs to move between the figures.

::: panel-tabset
## Reception

**Figure 5a. Percentage of Reception children who are overweight or obese by IDACI quintile and gender**

There is no significant difference in prevalence of overweight or obesity between boys and girls at any level of deprivation.

```{r obese_overweight_idaci_gender_r}
#| warning: false

graph <- data_md_gender_idaci_overweight_obese |> 
  filter(School_Year == "Reception") |>
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(tooltip = paste0(Gender, "\n",
                          "IDACI Quintile ", IDACI_2019_Quintile, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)")) |> 
  mutate(IDACI_2019_Quintile = case_when(IDACI_2019_Quintile == "5" ~ "5\n(least deprived)",
                                         IDACI_2019_Quintile == "1" ~ "1\n(most deprived)",
                                         .default = IDACI_2019_Quintile)) |> 
  mutate(IDACI_2019_Quintile = factor(IDACI_2019_Quintile,
                                      levels = c("5\n(least deprived)",
                                                 "4",
                                                 "3",
                                                 "2",
                                                 "1\n(most deprived)"))) |>
  ggplot(aes(x = pct,
             y = IDACI_2019_Quintile,
             fill = Gender)) +
  geom_col_interactive(aes(tooltip = tooltip),
                       position = "dodge") +
  geom_errorbar(aes(xmin = lower_ci,
                    xmax = upper_ci),
                width = 0.2,
                position = position_dodge(0.9)) +
  # geom_text(aes(x = label_pos,
  #               label = label)) +
  theme_classic() +
  scale_fill_manual(values = bcc_colours[2:3]) +
  scale_x_continuous(expand = c(0,0),
                     breaks = c(-60 ,-50, -40, -30, -20, -10, 0, 10, 20, 30, 40, 50, 60),
                     labels = c("60%", "50%", "40%", "30%", "20%", "10%", "0%", "10%", "20%", "30%", "40%", "50%", "60%"),
                     #labels = scales::label_percent(suffix = ""),
                     name = "Percentage of children\n overweight/obese") +
  scale_y_discrete(name = "IDACI Quintile")

girafe(ggobj = graph)
```

## Year 6

**Figure 5b. Percentage of Year 6 children who are overweight or obese by IDACI quintile and gender**

A higher proportion of boys than girls are overweight or obese in more deprived areas (quintiles 1, 2 and 3). In the two least deprived quintiles, there is no significant difference in prevalence between boys and girls.

```{r obese_overweight_idaci_gender_y6}
#| warning: false

graph <- data_md_gender_idaci_overweight_obese |> 
  filter(School_Year == "Year 6") |>
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(tooltip = paste0(Gender, "\n",
                          "IDACI Quintile ", IDACI_2019_Quintile, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)")) |> 
  mutate(IDACI_2019_Quintile = case_when(IDACI_2019_Quintile == "5" ~ "5\n(least deprived)",
                                         IDACI_2019_Quintile == "1" ~ "1\n(most deprived)",
                                         .default = IDACI_2019_Quintile)) |> 
  mutate(IDACI_2019_Quintile = factor(IDACI_2019_Quintile,
                                      levels = c("5\n(least deprived)",
                                                 "4",
                                                 "3",
                                                 "2",
                                                 "1\n(most deprived)"))) |>
  ggplot(aes(x = pct,
             y = IDACI_2019_Quintile,
             fill = Gender)) +
  geom_col_interactive(aes(tooltip = tooltip),
                       position = "dodge") +
  geom_errorbar(aes(xmin = lower_ci,
                    xmax = upper_ci),
                width = 0.2,
                position = position_dodge(0.9)) +
  # geom_text(aes(x = label_pos,
  #               label = label)) +
  theme_classic() +
  scale_fill_manual(values = bcc_colours[2:3]) +
  scale_x_continuous(expand = c(0,0),
                     breaks = c(-60 ,-50, -40, -30, -20, -10, 0, 10, 20, 30, 40, 50, 60),
                     labels = c("60%", "50%", "40%", "30%", "20%", "10%", "0%", "10%", "20%", "30%", "40%", "50%", "60%"),
                     #labels = scales::label_percent(suffix = ""),
                     name = "Percentage of children\n overweight/obese") +
  scale_y_discrete(name = "IDACI Quintile")

girafe(ggobj = graph)
```
:::

### Deprivation gap over time

```{r deprivation_gap_setup}
#| warning: false

trends_by_idaci_quintile_by_school_year_3yrs <- ncmp_data_3_years_combined |> 
  group_by(School_Year, BMI_Category, Year, IDACI_2019_Quintile) |> 
  count(name = "count") |> 
  ungroup() |> 
  group_by(School_Year, Year, IDACI_2019_Quintile) |> 
  mutate(denominator = sum(count))

trends_by_idaci_quintile_by_school_year_obese_overweight_3yrs <- ncmp_data_3_years_combined |>
  mutate(BMI_Category = case_when(BMI_Category == "Obese" ~ "Overweight/Obese",
                                  BMI_Category == "Overweight" ~ "Overweight/Obese",
                                  .default = BMI_Category)) |> 
  group_by(School_Year, BMI_Category, Year, IDACI_2019_Quintile) |> 
  count(name = "count") |> 
  ungroup() |> 
  group_by(School_Year, Year, IDACI_2019_Quintile) |> 
  mutate(denominator = sum(count)) |> 
  filter(BMI_Category == "Overweight/Obese")

trends_by_idaci_quintile_by_school_year_3yrs <- rbind(trends_by_idaci_quintile_by_school_year_3yrs,                                                trends_by_idaci_quintile_by_school_year_obese_overweight_3yrs)

trends_by_idaci_quintile_by_school_year_3yrs <- wilson_ci(trends_by_idaci_quintile_by_school_year_3yrs,
                                                     trends_by_idaci_quintile_by_school_year_3yrs$count,
                                                     trends_by_idaci_quintile_by_school_year_3yrs$denominator)
```

Figure 6(a-h) shows the percentage of children in IDACI quintiles 1 and 5 who are classed as underweight, overweight or obese for 3-year rolling periods over time. Use the tabs to move between the figures.

::::: panel-tabset
## Reception

::: panel-tabset
## Underweight

**Figure 6a. Percentage of Reception children who are underweight by IDACI quintile, over time**

For the past ten years, prevalence of underweight has been higher in children from the most deprived areas, but during most periods this difference was not statistically significant. There has been a significant increase in prevalence of underweight in children in IDACI quintile 1 between 2013-16 and 2021-24. The 'gap' between the two quintiles has no discernible trend.

```{r deprivation_gap_r_underweight}
#| warning: false

graph <- trends_by_idaci_quintile_by_school_year_3yrs |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |>
  filter(IDACI_2019_Quintile == 1|IDACI_2019_Quintile == 5) |> 
  #select(Year, School_Year, BMI_Category, IDACI_2019_Quintile, pct) |> 
  pivot_wider(names_from = IDACI_2019_Quintile,
              values_from = pct,
              id_cols = School_Year:Year) |>
  mutate(gap = abs(`5` - `1`)) |> 
  pivot_longer(cols = `1`:`5`,
               names_to = "IDACI_2019_Quintile",
               values_to = "pct") |> 
  left_join(trends_by_idaci_quintile_by_school_year_3yrs) |> 
  mutate(tooltip = paste0(Year, "\n",
                          "IDACI Quintile ", IDACI_2019_Quintile, "\n",
                          BMI_Category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n",
                          "Deprivation gap: ", round(gap, 1), "%")) |> 
  mutate(IDACI_2019_Quintile = case_when(IDACI_2019_Quintile == "5" ~ "5 (least deprived)",
                                         IDACI_2019_Quintile == "1" ~ "1 (most deprived)",
                                         .default = IDACI_2019_Quintile)) |> 
  filter(School_Year == "Reception",
         BMI_Category == "Underweight") |> 
  ggplot(aes(x = Year,
             y = pct,
             col = IDACI_2019_Quintile)) +
  geom_line_interactive(aes(group = IDACI_2019_Quintile),
                        linewidth = 1) +
  geom_errorbar(aes(ymin = lower_ci,
                    ymax = upper_ci),
                width = 0.2) +
  geom_point_interactive(aes(tooltip = tooltip,
                             data_id = Year),
                         #col = "white",
                         size = 2) +
  theme_classic() +
  scale_x_discrete() +
  scale_y_continuous(expand = c(0,0),
                     #limits = c(0,NA),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1),
                     name = "Percentage of children") +
  scale_colour_manual(values = c(bcc_colours),
                      name = "IDACI 2019 Quintile") +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank())

graph2 <- trends_by_idaci_quintile_by_school_year_3yrs |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |>
  filter(IDACI_2019_Quintile == 1|IDACI_2019_Quintile == 5) |>
  select(Year, School_Year, BMI_Category, IDACI_2019_Quintile, pct) |> 
  pivot_wider(names_from = IDACI_2019_Quintile,
              values_from = pct) |>
  mutate(gap = `1` - `5`) |> 
  pivot_longer(cols = `1`:`5`,
               names_to = "IDACI_2019_Quintile",
               values_to = "pct") |> 
  mutate(gap_pos = case_when(gap > 0 ~ "pos",
                             gap < 0 ~ "neg")) |> 
  mutate(tooltip = paste0(Year, "\n",
                          "Deprivation gap: ", round(abs(gap), 1), "%", "\n")) |> 
  filter(School_Year == "Reception",
         BMI_Category == "Underweight",
         IDACI_2019_Quintile == 1) |> 
  ggplot(aes(x = Year,
             y = gap,
             data_id = Year)) +
  geom_col_interactive(aes(fill = gap_pos,
                           tooltip = tooltip)) +
  theme_classic() +
  scale_x_discrete() +
  scale_y_continuous(expand = c(0,0),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1),
                     name = "Deprivation gap") +
  scale_fill_manual(values = c(bcc_colours)[3:4],
                    name = "Gap direction",
                    breaks = c("pos", "neg", NA),
                    labels = c("1 > 5", "5 > 1", NA),
                    na.translate = F) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

graph3 <- graph / graph2 +
  plot_layout(heights = c(3,1),
              guides ="collect")

girafe(ggobj = graph3,
       options = list(
         opts_hover(css = "fill:black;stroke:black")
       ))
```

## Overweight

**Figure 6b. Percentage of Reception children who are overweight by IDACI quintile, over time**

For the past ten years, prevalence of overweight has been higher in children from the most deprived areas, but during most periods this difference was not statistically significant. There has been a significant decrease in prevalence of overweight in children in IDACI quintile 1 between 2013-16 and 2021-24. The 'gap' between the two quintiles has no discernible trend.

```{r deprivation_gap_r_overweight}
#| warning: false

graph <- trends_by_idaci_quintile_by_school_year_3yrs |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |>
  filter(IDACI_2019_Quintile == 1|IDACI_2019_Quintile == 5) |> 
  #select(Year, School_Year, BMI_Category, IDACI_2019_Quintile, pct) |> 
  pivot_wider(names_from = IDACI_2019_Quintile,
              values_from = pct,
              id_cols = School_Year:Year) |>
  mutate(gap = abs(`5` - `1`)) |> 
  pivot_longer(cols = `1`:`5`,
               names_to = "IDACI_2019_Quintile",
               values_to = "pct") |> 
  left_join(trends_by_idaci_quintile_by_school_year_3yrs) |> 
  mutate(tooltip = paste0(Year, "\n",
                          "IDACI Quintile ", IDACI_2019_Quintile, "\n",
                          BMI_Category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n",
                          "Deprivation gap: ", round(gap, 1), "%")) |> 
  mutate(IDACI_2019_Quintile = case_when(IDACI_2019_Quintile == "5" ~ "5 (least deprived)",
                                         IDACI_2019_Quintile == "1" ~ "1 (most deprived)",
                                         .default = IDACI_2019_Quintile)) |> 
  filter(School_Year == "Reception",
         BMI_Category == "Overweight") |> 
  ggplot(aes(x = Year,
             y = pct,
             col = IDACI_2019_Quintile)) +
  geom_line_interactive(aes(group = IDACI_2019_Quintile),
                        linewidth = 1) +
  geom_errorbar(aes(ymin = lower_ci,
                    ymax = upper_ci),
                width = 0.2) +
  geom_point_interactive(aes(tooltip = tooltip,
                             data_id = Year),
                         #col = "white",
                         size = 2) +
  theme_classic() +
  scale_x_discrete() +
  scale_y_continuous(expand = c(0,0),
                     #limits = c(0,NA),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1),
                     name = "Percentage of children") +
  scale_colour_manual(values = c(bcc_colours),
                      name = "IDACI 2019 Quintile") +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank())

graph2 <- trends_by_idaci_quintile_by_school_year_3yrs |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |>
  filter(IDACI_2019_Quintile == 1|IDACI_2019_Quintile == 5) |>
  select(Year, School_Year, BMI_Category, IDACI_2019_Quintile, pct) |> 
  pivot_wider(names_from = IDACI_2019_Quintile,
              values_from = pct) |>
  mutate(gap = `1` - `5`) |> 
  pivot_longer(cols = `1`:`5`,
               names_to = "IDACI_2019_Quintile",
               values_to = "pct") |> 
  mutate(gap_pos = case_when(gap > 0 ~ "pos",
                             gap < 0 ~ "neg")) |> 
  mutate(tooltip = paste0(Year, "\n",
                          "Deprivation gap: ", round(abs(gap), 1), "%", "\n")) |> 
  filter(School_Year == "Reception",
         BMI_Category == "Overweight",
         IDACI_2019_Quintile == 1) |> 
  ggplot(aes(x = Year,
             y = gap,
             data_id = Year)) +
  geom_col_interactive(aes(fill = gap_pos,
                           tooltip = tooltip)) +
  theme_classic() +
  scale_x_discrete() +
  scale_y_continuous(expand = c(0,0),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1),
                     name = "Deprivation gap") +
  scale_fill_manual(values = c(bcc_colours)[3:4],
                    name = "Gap direction",
                    breaks = c("pos", "neg", NA),
                    labels = c("1 > 5", "5 > 1", NA),
                    na.translate = F) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

graph3 <- graph / graph2 +
  plot_layout(heights = c(3,1),
              guides ="collect")

girafe(ggobj = graph3,
       options = list(
         opts_hover(css = "fill:black;stroke:black")
       ))
```

## Obese

**Figure 6c. Percentage of Reception children who are obese by IDACI quintile, over time**

For the past ten years, prevalence of obesity has been higher in children from the most deprived areas, by an average of around 6%. The 'gap' between the two quintiles appears to be getting smaller - obesity prevalence in children in IDACI quintile 1 has stayed roughly the same between 2013-16 and 2021-24, while prevalence in children in IDACI quintile 5 has increased, though not significantly.

```{r deprivation_gap_r_obese}
#| warning: false

graph <- trends_by_idaci_quintile_by_school_year_3yrs |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |>
  filter(IDACI_2019_Quintile == 1|IDACI_2019_Quintile == 5) |> 
  #select(Year, School_Year, BMI_Category, IDACI_2019_Quintile, pct) |> 
  pivot_wider(names_from = IDACI_2019_Quintile,
              values_from = pct,
              id_cols = School_Year:Year) |>
  mutate(gap = abs(`5` - `1`)) |> 
  pivot_longer(cols = `1`:`5`,
               names_to = "IDACI_2019_Quintile",
               values_to = "pct") |> 
  left_join(trends_by_idaci_quintile_by_school_year_3yrs) |> 
  mutate(tooltip = paste0(Year, "\n",
                          "IDACI Quintile ", IDACI_2019_Quintile, "\n",
                          BMI_Category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n",
                          "Deprivation gap: ", round(gap, 1), "%")) |> 
  mutate(IDACI_2019_Quintile = case_when(IDACI_2019_Quintile == "5" ~ "5 (least deprived)",
                                         IDACI_2019_Quintile == "1" ~ "1 (most deprived)",
                                         .default = IDACI_2019_Quintile)) |> 
  filter(School_Year == "Reception",
         BMI_Category == "Obese") |> 
  ggplot(aes(x = Year,
             y = pct,
             col = IDACI_2019_Quintile)) +
  geom_line_interactive(aes(group = IDACI_2019_Quintile),
                        linewidth = 1) +
  geom_errorbar(aes(ymin = lower_ci,
                    ymax = upper_ci),
                width = 0.2) +
  geom_point_interactive(aes(tooltip = tooltip,
                             data_id = Year),
                         #col = "white",
                         size = 2) +
  theme_classic() +
  scale_x_discrete() +
  scale_y_continuous(expand = c(0,0),
                     #limits = c(0,NA),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1),
                     name = "Percentage of children") +
  scale_colour_manual(values = c(bcc_colours),
                      name = "IDACI 2019 Quintile") +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank())

graph2 <- trends_by_idaci_quintile_by_school_year_3yrs |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |>
  filter(IDACI_2019_Quintile == 1|IDACI_2019_Quintile == 5) |>
  select(Year, School_Year, BMI_Category, IDACI_2019_Quintile, pct) |> 
  pivot_wider(names_from = IDACI_2019_Quintile,
              values_from = pct) |>
  mutate(gap = `1` - `5`) |> 
  pivot_longer(cols = `1`:`5`,
               names_to = "IDACI_2019_Quintile",
               values_to = "pct") |> 
  mutate(gap_pos = case_when(gap > 0 ~ "pos",
                             gap < 0 ~ "neg")) |> 
  mutate(tooltip = paste0(Year, "\n",
                          "Deprivation gap: ", round(abs(gap), 1), "%", "\n")) |> 
  filter(School_Year == "Reception",
         BMI_Category == "Obese",
         IDACI_2019_Quintile == 1) |> 
  ggplot(aes(x = Year,
             y = gap,
             data_id = Year)) +
  geom_col_interactive(aes(fill = gap_pos,
                           tooltip = tooltip)) +
  theme_classic() +
  scale_x_discrete() +
  scale_y_continuous(expand = c(0,0),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1),
                     name = "Deprivation gap") +
  scale_fill_manual(values = c(bcc_colours)[3:4],
                    name = "Gap direction",
                    breaks = c("pos", "neg", NA),
                    labels = c("1 > 5", "5 > 1", NA),
                    na.translate = F) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

graph3 <- graph / graph2 +
  plot_layout(heights = c(3,1),
              guides ="collect")

girafe(ggobj = graph3,
       options = list(
         opts_hover(css = "fill:black;stroke:black")
       ))
```

## Overweight/Obese

**Figure 6d. Percentage of Reception children who are overweight or obese by IDACI quintile, over time**

For the past ten years, prevalence of overweight and obesity has been higher in children from the most deprived areas, by an average of around 7%. There has been a decrease in prevalence of overweight and obesity in children in IDACI quintile 1 between 2014-17 and 2021-24. The 'gap' between the two quintiles has no discernible trend.

```{r deprivation_gap_r_obese_overweight}
#| warning: false

graph <- trends_by_idaci_quintile_by_school_year_3yrs |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |>
  filter(IDACI_2019_Quintile == 1|IDACI_2019_Quintile == 5) |> 
  #select(Year, School_Year, BMI_Category, IDACI_2019_Quintile, pct) |> 
  pivot_wider(names_from = IDACI_2019_Quintile,
              values_from = pct,
              id_cols = School_Year:Year) |>
  mutate(gap = abs(`5` - `1`)) |> 
  pivot_longer(cols = `1`:`5`,
               names_to = "IDACI_2019_Quintile",
               values_to = "pct") |> 
  left_join(trends_by_idaci_quintile_by_school_year_3yrs) |> 
  mutate(tooltip = paste0(Year, "\n",
                          "IDACI Quintile ", IDACI_2019_Quintile, "\n",
                          BMI_Category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n",
                          "Deprivation gap: ", round(gap, 1), "%")) |> 
  mutate(IDACI_2019_Quintile = case_when(IDACI_2019_Quintile == "5" ~ "5 (least deprived)",
                                         IDACI_2019_Quintile == "1" ~ "1 (most deprived)",
                                         .default = IDACI_2019_Quintile)) |> 
  filter(School_Year == "Reception",
         BMI_Category == "Overweight/Obese") |> 
  ggplot(aes(x = Year,
             y = pct,
             col = IDACI_2019_Quintile)) +
  geom_line_interactive(aes(group = IDACI_2019_Quintile),
                        linewidth = 1) +
  geom_errorbar(aes(ymin = lower_ci,
                    ymax = upper_ci),
                width = 0.2) +
  geom_point_interactive(aes(tooltip = tooltip,
                             data_id = Year),
                         #col = "white",
                         size = 2) +
  theme_classic() +
  scale_x_discrete() +
  scale_y_continuous(expand = c(0,0),
                     #limits = c(0,NA),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1),
                     name = "Percentage of children") +
  scale_colour_manual(values = c(bcc_colours),
                      name = "IDACI 2019 Quintile") +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank())

graph2 <- trends_by_idaci_quintile_by_school_year_3yrs |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |>
  filter(IDACI_2019_Quintile == 1|IDACI_2019_Quintile == 5) |>
  select(Year, School_Year, BMI_Category, IDACI_2019_Quintile, pct) |> 
  pivot_wider(names_from = IDACI_2019_Quintile,
              values_from = pct) |>
  mutate(gap = `1` - `5`) |> 
  pivot_longer(cols = `1`:`5`,
               names_to = "IDACI_2019_Quintile",
               values_to = "pct") |> 
  mutate(gap_pos = case_when(gap > 0 ~ "pos",
                             gap < 0 ~ "neg")) |> 
  mutate(tooltip = paste0(Year, "\n",
                          "Deprivation gap: ", round(abs(gap), 1), "%", "\n")) |> 
  filter(School_Year == "Reception",
         BMI_Category == "Overweight/Obese",
         IDACI_2019_Quintile == 1) |> 
  ggplot(aes(x = Year,
             y = gap,
             data_id = Year)) +
  geom_col_interactive(aes(fill = gap_pos,
                           tooltip = tooltip)) +
  theme_classic() +
  scale_x_discrete() +
  scale_y_continuous(expand = c(0,0),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1),
                     name = "Deprivation gap") +
  scale_fill_manual(values = c(bcc_colours)[3:4],
                    name = "Gap direction",
                    breaks = c("pos", "neg", NA),
                    labels = c("1 > 5", "5 > 1", NA),
                    na.translate = F) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

graph3 <- graph / graph2 +
  plot_layout(heights = c(3,1),
              guides ="collect")

girafe(ggobj = graph3,
       options = list(
         opts_hover(css = "fill:black;stroke:black")
       ))
```
:::

## Year 6

::: panel-tabset
## Underweight

**Figure 6e. Percentage of Year 6 children who are underweight by IDACI quintile, over time**

For most of the past ten years, prevalence of underweight has been higher in children from the most deprived areas, but this difference was not statistically significant. There has been a significant increase in prevalence of underweight in children in IDACI quintile 1 between 2013-16 and 2021-24. The 'gap' between the two quintiles has no discernible trend.

```{r deprivation_gap_y6_underweight}
#| warning: false

graph <- trends_by_idaci_quintile_by_school_year_3yrs |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |>
  filter(IDACI_2019_Quintile == 1|IDACI_2019_Quintile == 5) |> 
  #select(Year, School_Year, BMI_Category, IDACI_2019_Quintile, pct) |> 
  pivot_wider(names_from = IDACI_2019_Quintile,
              values_from = pct,
              id_cols = School_Year:Year) |>
  mutate(gap = abs(`5` - `1`)) |> 
  pivot_longer(cols = `1`:`5`,
               names_to = "IDACI_2019_Quintile",
               values_to = "pct") |> 
  left_join(trends_by_idaci_quintile_by_school_year_3yrs) |> 
  mutate(tooltip = paste0(Year, "\n",
                          "IDACI Quintile ", IDACI_2019_Quintile, "\n",
                          BMI_Category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n",
                          "Deprivation gap: ", round(gap, 1), "%")) |> 
  mutate(IDACI_2019_Quintile = case_when(IDACI_2019_Quintile == "5" ~ "5 (least deprived)",
                                         IDACI_2019_Quintile == "1" ~ "1 (most deprived)",
                                         .default = IDACI_2019_Quintile)) |> 
  filter(School_Year == "Year 6",
         BMI_Category == "Underweight") |> 
  ggplot(aes(x = Year,
             y = pct,
             col = IDACI_2019_Quintile)) +
  geom_line_interactive(aes(group = IDACI_2019_Quintile),
                        linewidth = 1) +
  geom_errorbar(aes(ymin = lower_ci,
                    ymax = upper_ci),
                width = 0.2) +
  geom_point_interactive(aes(tooltip = tooltip,
                             data_id = Year),
                         #col = "white",
                         size = 2) +
  theme_classic() +
  scale_x_discrete() +
  scale_y_continuous(expand = c(0,0),
                     #limits = c(0,NA),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1),
                     name = "Percentage of children") +
  scale_colour_manual(values = c(bcc_colours),
                      name = "IDACI 2019 Quintile") +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank())

graph2 <- trends_by_idaci_quintile_by_school_year_3yrs |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |>
  filter(IDACI_2019_Quintile == 1|IDACI_2019_Quintile == 5) |>
  select(Year, School_Year, BMI_Category, IDACI_2019_Quintile, pct) |> 
  pivot_wider(names_from = IDACI_2019_Quintile,
              values_from = pct) |>
  mutate(gap = `1` - `5`) |> 
  pivot_longer(cols = `1`:`5`,
               names_to = "IDACI_2019_Quintile",
               values_to = "pct") |> 
  mutate(gap_pos = case_when(gap > 0 ~ "pos",
                             gap < 0 ~ "neg")) |> 
  mutate(tooltip = paste0(Year, "\n",
                          "Deprivation gap: ", round(abs(gap), 1), "%", "\n")) |> 
  filter(School_Year == "Year 6",
         BMI_Category == "Underweight",
         IDACI_2019_Quintile == 1) |> 
  ggplot(aes(x = Year,
             y = gap,
             data_id = Year)) +
  geom_col_interactive(aes(fill = gap_pos,
                           tooltip = tooltip)) +
  theme_classic() +
  scale_x_discrete() +
  scale_y_continuous(expand = c(0,0),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1),
                     name = "Deprivation gap") +
  scale_fill_manual(values = c(bcc_colours)[3:4],
                    name = "Gap direction",
                    breaks = c("pos", "neg", NA),
                    labels = c("1 > 5", "5 > 1", NA),
                    na.translate = F) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

graph3 <- graph / graph2 +
  plot_layout(heights = c(3,1),
              guides ="collect")

girafe(ggobj = graph3,
       options = list(
         opts_hover(css = "fill:black;stroke:black")
       ))
```

## Overweight

**Figure 6f. Percentage of Year 6 children who are overweight by IDACI quintile, over time**

Over the past ten years there has been a decrease in prevalence of overweight in children from the least deprived areas, and a non-significant increase in prevalence of overweight in children from the most deprived areas. As a result, in recent years (from the 2018-22 period onward) the 'gap' between the quintiles has reversed, with prevalence of overweight being higher in children in IDACI quintile 5. However, this difference is not statistically significant.

```{r deprivation_gap_y6_overweight}
#| warning: false

graph <- trends_by_idaci_quintile_by_school_year_3yrs |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |>
  filter(IDACI_2019_Quintile == 1|IDACI_2019_Quintile == 5) |> 
  #select(Year, School_Year, BMI_Category, IDACI_2019_Quintile, pct) |> 
  pivot_wider(names_from = IDACI_2019_Quintile,
              values_from = pct,
              id_cols = School_Year:Year) |>
  mutate(gap = abs(`5` - `1`)) |> 
  pivot_longer(cols = `1`:`5`,
               names_to = "IDACI_2019_Quintile",
               values_to = "pct") |> 
  left_join(trends_by_idaci_quintile_by_school_year_3yrs) |> 
  mutate(tooltip = paste0(Year, "\n",
                          "IDACI Quintile ", IDACI_2019_Quintile, "\n",
                          BMI_Category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n",
                          "Deprivation gap: ", round(gap, 1), "%")) |> 
  mutate(IDACI_2019_Quintile = case_when(IDACI_2019_Quintile == "5" ~ "5 (least deprived)",
                                         IDACI_2019_Quintile == "1" ~ "1 (most deprived)",
                                         .default = IDACI_2019_Quintile)) |> 
  filter(School_Year == "Year 6",
         BMI_Category == "Overweight") |> 
  ggplot(aes(x = Year,
             y = pct,
             col = IDACI_2019_Quintile)) +
  geom_line_interactive(aes(group = IDACI_2019_Quintile),
                        linewidth = 1) +
  geom_errorbar(aes(ymin = lower_ci,
                    ymax = upper_ci),
                width = 0.2) +
  geom_point_interactive(aes(tooltip = tooltip,
                             data_id = Year),
                         #col = "white",
                         size = 2) +
  theme_classic() +
  scale_x_discrete() +
  scale_y_continuous(expand = c(0,0),
                     #limits = c(0,NA),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1),
                     name = "Percentage of children") +
  scale_colour_manual(values = c(bcc_colours),
                      name = "IDACI 2019 Quintile") +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank())

graph2 <- trends_by_idaci_quintile_by_school_year_3yrs |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |>
  filter(IDACI_2019_Quintile == 1|IDACI_2019_Quintile == 5) |>
  select(Year, School_Year, BMI_Category, IDACI_2019_Quintile, pct) |> 
  pivot_wider(names_from = IDACI_2019_Quintile,
              values_from = pct) |>
  mutate(gap = `1` - `5`) |> 
  pivot_longer(cols = `1`:`5`,
               names_to = "IDACI_2019_Quintile",
               values_to = "pct") |> 
  mutate(gap_pos = case_when(gap > 0 ~ "pos",
                             gap < 0 ~ "neg")) |> 
  mutate(tooltip = paste0(Year, "\n",
                          "Deprivation gap: ", round(abs(gap), 1), "%", "\n")) |> 
  filter(School_Year == "Year 6",
         BMI_Category == "Overweight",
         IDACI_2019_Quintile == 1) |> 
  ggplot(aes(x = Year,
             y = gap,
             data_id = Year)) +
  geom_col_interactive(aes(fill = gap_pos,
                           tooltip = tooltip)) +
  theme_classic() +
  scale_x_discrete() +
  scale_y_continuous(expand = c(0,0),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1),
                     name = "Deprivation gap") +
  scale_fill_manual(values = c(bcc_colours)[3:4],
                    name = "Gap direction",
                    breaks = c("pos", "neg", NA),
                    labels = c("1 > 5", "5 > 1", NA),
                    na.translate = F) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

graph3 <- graph / graph2 +
  plot_layout(heights = c(3,1),
              guides ="collect")

girafe(ggobj = graph3,
       options = list(
         opts_hover(css = "fill:black;stroke:black")
       ))
```

## Obese

**Figure 6g. Percentage of Year 6 children who are obese by IDACI quintile, over time**

For the past ten years, prevalence of obesity has been higher in children from the most deprived areas. The 'gap' between the two quintiles appears to be getting larger - obesity prevalence in children in IDACI quintile 1 has increased between 2013-16 and 2021-24, while prevalence in children in IDACI quintile 5 has stayed roughly the same.

```{r deprivation_gap_y6_obese}
#| warning: false

graph <- trends_by_idaci_quintile_by_school_year_3yrs |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |>
  filter(IDACI_2019_Quintile == 1|IDACI_2019_Quintile == 5) |> 
  #select(Year, School_Year, BMI_Category, IDACI_2019_Quintile, pct) |> 
  pivot_wider(names_from = IDACI_2019_Quintile,
              values_from = pct,
              id_cols = School_Year:Year) |>
  mutate(gap = abs(`5` - `1`)) |> 
  pivot_longer(cols = `1`:`5`,
               names_to = "IDACI_2019_Quintile",
               values_to = "pct") |> 
  left_join(trends_by_idaci_quintile_by_school_year_3yrs) |> 
  mutate(tooltip = paste0(Year, "\n",
                          "IDACI Quintile ", IDACI_2019_Quintile, "\n",
                          BMI_Category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n",
                          "Deprivation gap: ", round(gap, 1), "%")) |> 
  mutate(IDACI_2019_Quintile = case_when(IDACI_2019_Quintile == "5" ~ "5 (least deprived)",
                                         IDACI_2019_Quintile == "1" ~ "1 (most deprived)",
                                         .default = IDACI_2019_Quintile)) |> 
  filter(School_Year == "Year 6",
         BMI_Category == "Obese") |> 
  ggplot(aes(x = Year,
             y = pct,
             col = IDACI_2019_Quintile)) +
  geom_line_interactive(aes(group = IDACI_2019_Quintile),
                        linewidth = 1) +
  geom_errorbar(aes(ymin = lower_ci,
                    ymax = upper_ci),
                width = 0.2) +
  geom_point_interactive(aes(tooltip = tooltip,
                             data_id = Year),
                         #col = "white",
                         size = 2) +
  theme_classic() +
  scale_x_discrete() +
  scale_y_continuous(expand = c(0,0),
                     #limits = c(0,NA),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1),
                     name = "Percentage of children") +
  scale_colour_manual(values = c(bcc_colours),
                      name = "IDACI 2019 Quintile") +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank())

graph2 <- trends_by_idaci_quintile_by_school_year_3yrs |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |>
  filter(IDACI_2019_Quintile == 1|IDACI_2019_Quintile == 5) |>
  select(Year, School_Year, BMI_Category, IDACI_2019_Quintile, pct) |> 
  pivot_wider(names_from = IDACI_2019_Quintile,
              values_from = pct) |>
  mutate(gap = `1` - `5`) |> 
  pivot_longer(cols = `1`:`5`,
               names_to = "IDACI_2019_Quintile",
               values_to = "pct") |> 
  mutate(gap_pos = case_when(gap > 0 ~ "pos",
                             gap < 0 ~ "neg")) |> 
  mutate(tooltip = paste0(Year, "\n",
                          "Deprivation gap: ", round(abs(gap), 1), "%", "\n")) |> 
  filter(School_Year == "Year 6",
         BMI_Category == "Obese",
         IDACI_2019_Quintile == 1) |> 
  ggplot(aes(x = Year,
             y = gap,
             data_id = Year)) +
  geom_col_interactive(aes(fill = gap_pos,
                           tooltip = tooltip)) +
  theme_classic() +
  scale_x_discrete() +
  scale_y_continuous(expand = c(0,0),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1),
                     name = "Deprivation gap") +
  scale_fill_manual(values = c(bcc_colours)[3:4],
                    name = "Gap direction",
                    breaks = c("pos", "neg", NA),
                    labels = c("1 > 5", "5 > 1", NA),
                    na.translate = F) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

graph3 <- graph / graph2 +
  plot_layout(heights = c(3,1),
              guides ="collect")

girafe(ggobj = graph3,
       options = list(
         opts_hover(css = "fill:black;stroke:black")
       ))
```

## Overweight/Obese

**Figure 6h. Percentage of Year 6 children who are overweight or obese by IDACI quintile, over time**

For the past ten years, prevalence of overweight and obesity has been higher in children from the most deprived areas. The 'gap' between the two quintiles appears to be getting slightly larger - overweight and obesity prevalence in children in IDACI quintile 1 has increased between 2013-16 and 2021-24, while prevalence in children in IDACI quintile 5 has stayed roughly the same.

```{r deprivation_gap_y6_obese_overweight}
#| warning: false

graph <- trends_by_idaci_quintile_by_school_year_3yrs |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |>
  filter(IDACI_2019_Quintile == 1|IDACI_2019_Quintile == 5) |> 
  #select(Year, School_Year, BMI_Category, IDACI_2019_Quintile, pct) |> 
  pivot_wider(names_from = IDACI_2019_Quintile,
              values_from = pct,
              id_cols = School_Year:Year) |>
  mutate(gap = abs(`5` - `1`)) |> 
  pivot_longer(cols = `1`:`5`,
               names_to = "IDACI_2019_Quintile",
               values_to = "pct") |> 
  left_join(trends_by_idaci_quintile_by_school_year_3yrs) |> 
  mutate(tooltip = paste0(Year, "\n",
                          "IDACI Quintile ", IDACI_2019_Quintile, "\n",
                          BMI_Category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n",
                          "Deprivation gap: ", round(gap, 1), "%")) |> 
  mutate(IDACI_2019_Quintile = case_when(IDACI_2019_Quintile == "5" ~ "5 (least deprived)",
                                         IDACI_2019_Quintile == "1" ~ "1 (most deprived)",
                                         .default = IDACI_2019_Quintile)) |> 
  filter(School_Year == "Year 6",
         BMI_Category == "Overweight/Obese") |> 
  ggplot(aes(x = Year,
             y = pct,
             col = IDACI_2019_Quintile)) +
  geom_line_interactive(aes(group = IDACI_2019_Quintile),
                        linewidth = 1) +
  geom_errorbar(aes(ymin = lower_ci,
                    ymax = upper_ci),
                width = 0.2) +
  geom_point_interactive(aes(tooltip = tooltip,
                             data_id = Year),
                         #col = "white",
                         size = 2) +
  theme_classic() +
  scale_x_discrete() +
  scale_y_continuous(expand = c(0,0),
                     #limits = c(0,NA),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1),
                     name = "Percentage of children") +
  scale_colour_manual(values = c(bcc_colours),
                      name = "IDACI 2019 Quintile") +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank())

graph2 <- trends_by_idaci_quintile_by_school_year_3yrs |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |>
  filter(IDACI_2019_Quintile == 1|IDACI_2019_Quintile == 5) |>
  select(Year, School_Year, BMI_Category, IDACI_2019_Quintile, pct) |> 
  pivot_wider(names_from = IDACI_2019_Quintile,
              values_from = pct) |>
  mutate(gap = `1` - `5`) |> 
  pivot_longer(cols = `1`:`5`,
               names_to = "IDACI_2019_Quintile",
               values_to = "pct") |> 
  mutate(gap_pos = case_when(gap > 0 ~ "pos",
                             gap < 0 ~ "neg")) |> 
  mutate(tooltip = paste0(Year, "\n",
                          "Deprivation gap: ", round(abs(gap), 1), "%", "\n")) |> 
  filter(School_Year == "Year 6",
         BMI_Category == "Overweight/Obese",
         IDACI_2019_Quintile == 1) |> 
  ggplot(aes(x = Year,
             y = gap,
             data_id = Year)) +
  geom_col_interactive(aes(fill = gap_pos,
                           tooltip = tooltip)) +
  theme_classic() +
  scale_x_discrete() +
  scale_y_continuous(expand = c(0,0),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1),
                     name = "Deprivation gap") +
  scale_fill_manual(values = c(bcc_colours)[3:4],
                    name = "Gap direction",
                    breaks = c("pos", "neg", NA),
                    labels = c("1 > 5", "5 > 1", NA),
                    na.translate = F) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

graph3 <- graph / graph2 +
  plot_layout(heights = c(3,1),
              guides ="collect")

girafe(ggobj = graph3,
       options = list(
         opts_hover(css = "fill:black;stroke:black")
       ))
```
:::
:::::

## By Ethnicity

This section investigates the effect of ethnicity on BMI category. There are known disparities in weight status by ethnicity at a national level, with Black and Asian children typically having higher prevalence of obesity than children of White ethnicity[^3]. The same is broadly true in Birmingham for the Year 6 age group, though not for Reception-age children.

[^3]: NHS Digital, National Child Measurement Programme, England, 2023/24

Ethnicity is grouped at the broadest possible level to improve data robustness (see caveat below). The groups used are Asian, Black, Mixed, Other and White, plus a sixth category, Unknown, which is used when data on ethnicity is not recorded. The Unknown category has been included in graphs but is not included in written commentary.

::: callout-warning
## Important Note

It is important to note that some ethnicities are better represented than others in the data. Asian and White children make up the biggest cohorts, making up around 35% and 29% of children respectively. The smallest groups are children of Mixed or Other ethnicity, each representing less than 7% of children, while around 11% of children are Black. As a result, the sample sizes for Black, Mixed and Other ethnicities are relatively small, meaning confidence intervals are generally large and statistical significance is harder to achieve. This should be taken into account when e.g. considering changes over time or comparing groups.
:::

### BMI Category by Ethnicity

```{r bmi_cat_ethnicity_setup}
#| warning: false
bmi_category_by_school_year_by_ethnicity <- ncmp_data_period_8 |> 
  group_by(School_Year, Ethnicity, BMI_Category) |>
  count(name = "count") |> 
  ungroup() |> 
  group_by(School_Year, Ethnicity) |> 
  mutate(denominator = sum(count))

bmi_category_by_school_year_by_ethnicity <- wilson_ci(bmi_category_by_school_year_by_ethnicity,
                                                        bmi_category_by_school_year_by_ethnicity$count,
                                                        bmi_category_by_school_year_by_ethnicity$denominator)
```

Figures 7a and 7b show the percentage of children who fall into each of the four BMI categories (underweight, healthy weight, overweight and obese), split by ethnicity, for the 3-year period `{r} periods_short[8]`. Use the tabs to move between the figures.

::: panel-tabset
## Reception

**Figure 7a. Percentage of Reception children in each BMI category by ethnicity**

Prevalence of obesity is highest in Black and Mixed ethnicity children, while prevalence of overweight is highest in White and Mixed ethnicity children. Asian children have the highest prevalence of underweight.

```{r bmi_cat_ethnicity_r}
#| warning: false
graph <- bmi_category_by_school_year_by_ethnicity |> 
  filter(School_Year == "Reception") |> 
  mutate(tooltip = paste0(Ethnicity, "\n", 
                          BMI_Category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n")) |> 
  mutate(BMI_Category = factor(BMI_Category,
                               levels = c("Obese", "Overweight", "Healthy Weight", "Underweight"))) |> 
  ggplot(aes(x = pct, 
             y = Ethnicity)) +
  geom_col_interactive(aes(fill = BMI_Category,
                           tooltip = tooltip)) +
  scale_fill_manual(values = c(bcc_colours[4:2], bcc_colours[5])) +
  scale_colour_manual(values = c("black", "white")) +
  theme_minimal() +
  scale_x_continuous(expand = c(0,0),
                     label = scales::label_percent(scale = 1),
                     name = "Percentage of children") +
  scale_y_discrete(name = "Ethnicity") +
  guides(fill = guide_legend(reverse = T,
                             title = "BMI Category"),
         colour = "none")

girafe(ggobj = graph)
```

## Year 6

**Figure 7b. Percentage of Year 6 children in each BMI category by ethnicity**

Prevalence of obesity is highest in Black, Asian and Mixed ethnicity children, while prevalence of overweight is roughly the same across ethnicities. Asian children have the highest prevalence of underweight.

```{r bmi_cat_ethnicity_y6}
#| warning: false
graph <- bmi_category_by_school_year_by_ethnicity |> 
  filter(School_Year == "Year 6") |> 
  mutate(tooltip = paste0(Ethnicity, "\n", 
                          BMI_Category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n")) |> 
  mutate(BMI_Category = factor(BMI_Category,
                               levels = c("Obese", "Overweight", "Healthy Weight", "Underweight"))) |> 
  ggplot(aes(x = pct, 
             y = Ethnicity)) +
  geom_col_interactive(aes(fill = BMI_Category,
                           tooltip = tooltip)) +
  scale_fill_manual(values = c(bcc_colours[4:2], bcc_colours[5])) +
  scale_colour_manual(values = c("black", "white")) +
  theme_minimal() +
  scale_x_continuous(expand = c(0,0),
                     label = scales::label_percent(scale = 1),
                     name = "Percentage of children") +
  scale_y_discrete(name = "Ethnicity") +
  guides(fill = guide_legend(reverse = T,
                             title = "BMI Category"),
         colour = "none")

girafe(ggobj = graph)
```
:::

### Overweight/Obese by Ethnicity and Gender

```{r obese_overweight_gender_ethnicity_setup}
#| warning: false
data_md_gender_ethnicity_overweight_obese <- ncmp_data_period_8 |> 
  mutate(BMI_Category = case_when(BMI_Category == "Obese" ~ "Overweight/Obese",
                                  BMI_Category == "Overweight" ~ "Overweight/Obese",
                                  .default = BMI_Category)) |> 
  group_by(School_Year, Gender, Ethnicity, BMI_Category) |> 
  count() |> 
  ungroup() |> 
  group_by(School_Year, Gender, Ethnicity) |> 
  mutate(denominator = sum(n)) |> 
  rename(count = n) |> 
  filter(BMI_Category == "Overweight/Obese")

data_md_gender_ethnicity_overweight_obese <-  wilson_ci(data_md_gender_ethnicity_overweight_obese,
                                                        data_md_gender_ethnicity_overweight_obese$count,
                                                        data_md_gender_ethnicity_overweight_obese$denominator)
```

Figures 8a and 8b show the percentage of girls and boys who are classed as either overweight or obese, split by ethnicity, for the 3-year period `{r} periods_short[8]`. Use the tabs to move between the figures.

::: panel-tabset
## Reception

**Figure 8a. Percentage of Reception children who are overweight or obese by ethnicity and gender**

For children of most ethnicities, there is no significant difference in prevalence of overweight or obesity between boys and girls. However, Asian girls have higher prevalence than Asian boys.

```{r obese_overweight_gender_ethnicity_r}
#| warning: false
graph <- data_md_gender_ethnicity_overweight_obese |> 
  filter(School_Year == "Reception") |>
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(tooltip = paste0(Gender, "\n",
                          Ethnicity, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)")) |>
  ggplot(aes(x = pct,
             y = Ethnicity,
             fill = Gender)) +
  geom_col_interactive(aes(tooltip = tooltip),
                       position = "dodge") +
  geom_errorbar(aes(xmin = lower_ci,
                    xmax = upper_ci),
                width = 0.2,
                position = position_dodge(0.9)) +
  # geom_text(aes(x = label_pos,
  #               label = label)) +
  theme_classic() +
  scale_fill_manual(values = bcc_colours[2:3]) +
  scale_x_continuous(expand = c(0,0),
                     labels = scales::label_percent(scale = 1),
                     name = "Percentage of children\n overweight/obese") +
  scale_y_discrete(name = "Ethnicity")

girafe(ggobj = graph)
```

## Year 6

**Figure 8b. Percentage of Year 6 children who are overweight or obese by ethnicity and gender**

Boys of White, Asian or Other ethnicity have a higher prevalence of overweight or obesity than their female counterparts. The gap between boys and girls is largest in Asian children. For Black and Mixed ethnicity children there is no significant difference in prevalence between the genders.

```{r obese_overweight_gender_ethnicity_y6}
#| warning: false
graph <- data_md_gender_ethnicity_overweight_obese |> 
  filter(School_Year == "Year 6") |>
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(tooltip = paste0(Gender, "\n",
                          Ethnicity, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)")) |>
  ggplot(aes(x = pct,
             y = Ethnicity,
             fill = Gender)) +
  geom_col_interactive(aes(tooltip = tooltip),
                       position = "dodge") +
  geom_errorbar(aes(xmin = lower_ci,
                    xmax = upper_ci),
                width = 0.2,
                position = position_dodge(0.9)) +
  # geom_text(aes(x = label_pos,
  #               label = label)) +
  theme_classic() +
  scale_fill_manual(values = bcc_colours[2:3]) +
  scale_x_continuous(expand = c(0,0),
                     labels = scales::label_percent(scale = 1),
                     name = "Percentage of children\n overweight/obese") +
  scale_y_discrete(name = "Ethnicity")

girafe(ggobj = graph)
```
:::

### Trends by Ethnicity

```{r trends_ethnicity_setup}
#| warning: false

trends_by_ethnicity_by_school_year_3yrs <- ncmp_data_3_years_combined |> 
  group_by(School_Year, BMI_Category, Year, Ethnicity) |> 
  count(name = "count") |> 
  ungroup() |> 
  group_by(School_Year, Year, Ethnicity) |> 
  mutate(denominator = sum(count))

trends_by_ethnicity_by_school_year_obese_overweight_3yrs <- ncmp_data_3_years_combined |>
  mutate(BMI_Category = case_when(BMI_Category == "Obese" ~ "Overweight/Obese",
                                  BMI_Category == "Overweight" ~ "Overweight/Obese",
                                  .default = BMI_Category)) |> 
  group_by(School_Year, BMI_Category, Year, Ethnicity) |> 
  count(name = "count") |> 
  ungroup() |> 
  group_by(School_Year, Year, Ethnicity) |> 
  mutate(denominator = sum(count)) |> 
  filter(BMI_Category == "Overweight/Obese")

trends_by_ethnicity_by_school_year_3yrs <- rbind(trends_by_ethnicity_by_school_year_3yrs,
                                                      trends_by_ethnicity_by_school_year_obese_overweight_3yrs)

trends_by_ethnicity_by_school_year_3yrs <- wilson_ci(trends_by_ethnicity_by_school_year_3yrs,
                                                          trends_by_ethnicity_by_school_year_3yrs$count,
                                                          trends_by_ethnicity_by_school_year_3yrs$denominator)
```

Figure 9(a-h) shows the percentage of children of each ethnicity who are classed as underweight, overweight or obese for 3-year rolling periods over time. Use the tabs to move between the figures.

::: {.callout-note .column-margin}
Note that these figures allow you to select which traces are visible, for ease of comparison. To hide a trace, click on the corresponding symbol in the legend. For example, to hide values for children of unknown ethnicity, click on the blue symbol labelled 'Unknown'. To view a single trace and hide all others, double click on its symbol in the legend.
:::

::::: panel-tabset
## Reception

::: panel-tabset
## Underweight

**Figure 9a. Percentage of Reception children who are underweight by ethnicity, over time**

Asian children have consistently had higher prevalence of underweight than children of all other ethnicities for the past ten years, with no significant change in prevalence. Prevalence of underweight has been lower in White children than all other ethnicities since 2016-19.

```{r trends_ethnicity_r_underweight}
#| warning: false
graph <- trends_by_ethnicity_by_school_year_3yrs |> 
  filter(BMI_Category == "Underweight",
         School_Year == "Reception") |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(tooltip = paste0(Year, "\n",
                          Ethnicity, "\n",
                          BMI_Category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)")) |> 
  ggplot(aes(x = Year,
             y = pct,
             col = Ethnicity)) +
  geom_line(aes(group = Ethnicity,
                text = tooltip),
            linewidth = 1) +
  geom_point(aes(text = tooltip),
                         #col = "white"
                         size = 2) +
  geom_errorbar(aes(ymin = lower_ci,
                    ymax = upper_ci),
                width = 0.2) +
  theme_classic() +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0),
                     #limits = c(8,22),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1)) +
  scale_colour_manual(values = c(bcc_colours),
                      name = "Ethnicity") +
  # scale_shape_manual(values = c(15, 16, 17, 18, 8, 4),
  #                    name = "Ethnicity") +
  ylab("Percentage of children") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

ggplotly(graph, tooltip = "text",
         height = 600) |> 
  config(modeBarButtonsToRemove = c('zoom', 'pan', 'select', 'zoomIn', 'zoomOut', 'lasso2d', 'autoScale', 'resetScale'),
         displaylogo = F)
```

## Overweight

**Figure 9b. Percentage of Reception children who are overweight by ethnicity, over time**

Over the past ten years, prevalence of overweight has generally been similar (i.e. not significantly different) in children of White, Black, Mixed and other ethnicities, with no significant changes in prevalence over time. Prevalence of overweight in Asian children has remained lower than all other groups and has seen a small but significant decrease between 2013-16 and 2021-24.

```{r trends_ethnicity_r_overweight}
#| warning: false
graph <- trends_by_ethnicity_by_school_year_3yrs |> 
  filter(BMI_Category == "Overweight",
         School_Year == "Reception") |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(tooltip = paste0(Year, "\n",
                          Ethnicity, "\n",
                          BMI_Category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)")) |> 
  ggplot(aes(x = Year,
             y = pct,
             col = Ethnicity)) +
  geom_line(aes(group = Ethnicity,
                text = tooltip),
            linewidth = 1) +
  geom_point(aes(text = tooltip),
                         #col = "white"
                         size = 2) +
  geom_errorbar(aes(ymin = lower_ci,
                    ymax = upper_ci),
                width = 0.2) +
  theme_classic() +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0),
                     #limits = c(8,22),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1)) +
  scale_colour_manual(values = c(bcc_colours),
                      name = "Ethnicity") +
  # scale_shape_manual(values = c(15, 16, 17, 18, 8, 4),
  #                    name = "Ethnicity") +
  ylab("Percentage of children") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

ggplotly(graph, tooltip = "text",
         height = 600) |> 
  config(modeBarButtonsToRemove = c('zoom', 'pan', 'select', 'zoomIn', 'zoomOut', 'lasso2d', 'autoScale', 'resetScale'),
         displaylogo = F)
```

## Obese

**Figure 9c. Percentage of Reception children who are obese by ethnicity, over time**

In the most recent period (2021-24) prevalence of obesity is statistically similar (i.e. not significantly different) across all ethnicities. However, in 2013-16, Black children had a higher prevalence than all other ethnicities. Although prevalence of obesity in Black children appears to have decreased over the past ten years, while prevalence in White children appears to have increased, these changes are not statistically significant.

```{r trends_ethnicity_r_obese}
#| warning: false
graph <- trends_by_ethnicity_by_school_year_3yrs |> 
  filter(BMI_Category == "Obese",
         School_Year == "Reception") |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(tooltip = paste0(Year, "\n",
                          Ethnicity, "\n",
                          BMI_Category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)")) |> 
  ggplot(aes(x = Year,
             y = pct,
             col = Ethnicity)) +
  geom_line(aes(group = Ethnicity,
                text = tooltip),
            linewidth = 1) +
  geom_point(aes(text = tooltip),
                         #col = "white"
                         size = 2) +
  geom_errorbar(aes(ymin = lower_ci,
                    ymax = upper_ci),
                width = 0.2) +
  theme_classic() +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0),
                     #limits = c(8,22),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1)) +
  scale_colour_manual(values = c(bcc_colours),
                      name = "Ethnicity") +
  # scale_shape_manual(values = c(15, 16, 17, 18, 8, 4),
  #                    name = "Ethnicity") +
  ylab("Percentage of children") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

ggplotly(graph, tooltip = "text",
         height = 600) |> 
  config(modeBarButtonsToRemove = c('zoom', 'pan', 'select', 'zoomIn', 'zoomOut', 'lasso2d', 'autoScale', 'resetScale'),
         displaylogo = F)
```

## Overweight/Obese

**Figure 9d. Percentage of Reception children who are overweight or obese by ethnicity, over time**

Over the past ten years, prevalence of overweight and obesity has generally been similar (i.e. not significantly different) in children of White, Black, Mixed and other ethnicities. However, the proportion of Black children who are overweight or obese has decreased between 2013-16 and 2021/24. Prevalence of overweight and obesity in Asian children has remained lower than all other groups since 2015-18 and has seen a small but significant decrease between this period and 2021-24.

```{r trends_ethnicity_r_obese_overweight}
#| warning: false
graph <- trends_by_ethnicity_by_school_year_3yrs |> 
  filter(BMI_Category == "Overweight/Obese",
         School_Year == "Reception") |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(tooltip = paste0(Year, "\n",
                          Ethnicity, "\n",
                          BMI_Category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)")) |> 
  ggplot(aes(x = Year,
             y = pct,
             col = Ethnicity)) +
  geom_line(aes(group = Ethnicity,
                text = tooltip),
            linewidth = 1) +
  geom_point(aes(text = tooltip),
                         #col = "white"
                         size = 2) +
  geom_errorbar(aes(ymin = lower_ci,
                    ymax = upper_ci),
                width = 0.2) +
  theme_classic() +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0),
                     #limits = c(8,22),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1)) +
  scale_colour_manual(values = c(bcc_colours),
                      name = "Ethnicity") +
  # scale_shape_manual(values = c(15, 16, 17, 18, 8, 4),
  #                    name = "Ethnicity") +
  ylab("Percentage of children") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

ggplotly(graph, tooltip = "text",
         height = 600) |> 
  config(modeBarButtonsToRemove = c('zoom', 'pan', 'select', 'zoomIn', 'zoomOut', 'lasso2d', 'autoScale', 'resetScale'),
         displaylogo = F)
```
:::

## Year 6

::: panel-tabset
## Underweight

**Figure 9e. Percentage of Year 6 children who are underweight by ethnicity, over time**

Asian children have consistently had higher prevalence of underweight than children of all other ethnicities for the past ten years, with no significant change in prevalence. Prevalence of underweight has generally been similar (i.e. not significantly different) in children of all other ethnicities, although children of Black and Other ethnicities have had a higher prevalence than White children since 2016-19. Prevalence of underweight in Black children has increased by a small but significant amount over the past ten years.

```{r trends_ethnicity_y6_underweight}
#| warning: false
graph <- trends_by_ethnicity_by_school_year_3yrs |> 
  filter(BMI_Category == "Underweight",
         School_Year == "Year 6") |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(tooltip = paste0(Year, "\n",
                          Ethnicity, "\n",
                          BMI_Category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)")) |> 
  ggplot(aes(x = Year,
             y = pct,
             col = Ethnicity)) +
  geom_line(aes(group = Ethnicity,
                text = tooltip),
            linewidth = 1) +
  geom_point(aes(text = tooltip),
                         #col = "white"
                         size = 2) +
  geom_errorbar(aes(ymin = lower_ci,
                    ymax = upper_ci),
                width = 0.2) +
  theme_classic() +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0),
                     #limits = c(8,22),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1)) +
  scale_colour_manual(values = c(bcc_colours),
                      name = "Ethnicity") +
  # scale_shape_manual(values = c(15, 16, 17, 18, 8, 4),
  #                    name = "Ethnicity") +
  ylab("Percentage of children") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

ggplotly(graph, tooltip = "text",
         height = 600) |> 
  config(modeBarButtonsToRemove = c('zoom', 'pan', 'select', 'zoomIn', 'zoomOut', 'lasso2d', 'autoScale', 'resetScale'),
         displaylogo = F)
```

## Overweight

**Figure 9f. Percentage of Year 6 children who are overweight by ethnicity, over time**

Over the past ten years, prevalence of overweight has generally been similar (i.e. not significantly different) across all ethnicities. Prevalence of overweight in Black children has decreased between 2013-16 and 2021-24, with all other ethnicities seeing no significant change in prevalence.

```{r trends_ethnicity_y6_overweight}
#| warning: false
graph <- trends_by_ethnicity_by_school_year_3yrs |> 
  filter(BMI_Category == "Overweight",
         School_Year == "Year 6") |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(tooltip = paste0(Year, "\n",
                          Ethnicity, "\n",
                          BMI_Category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)")) |> 
  ggplot(aes(x = Year,
             y = pct,
             col = Ethnicity)) +
  geom_line(aes(group = Ethnicity,
                text = tooltip),
            linewidth = 1) +
  geom_point(aes(text = tooltip),
                         #col = "white"
                         size = 2) +
  geom_errorbar(aes(ymin = lower_ci,
                    ymax = upper_ci),
                width = 0.2) +
  theme_classic() +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0),
                     #limits = c(8,22),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1)) +
  scale_colour_manual(values = c(bcc_colours),
                      name = "Ethnicity") +
  # scale_shape_manual(values = c(15, 16, 17, 18, 8, 4),
  #                    name = "Ethnicity") +
  ylab("Percentage of children") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

ggplotly(graph, tooltip = "text",
         height = 600) |> 
  config(modeBarButtonsToRemove = c('zoom', 'pan', 'select', 'zoomIn', 'zoomOut', 'lasso2d', 'autoScale', 'resetScale'),
         displaylogo = F)
```

## Obese

**Figure 9g. Percentage of Year 6 children who are obese by ethnicity, over time**

Over the past ten years, prevalence of overweight has remained lower in children of White ethnicity than those of Asian, Black and Mixed ethnicities. However, prevalence of overweight in White children has increased in this time. In the most recent period (2021-24), children of Other ethnicities have a prevalence which is similar to White children, and lower than Asian and Black children.

```{r trends_ethnicity_y6_obese}
#| warning: false
graph <- trends_by_ethnicity_by_school_year_3yrs |> 
  filter(BMI_Category == "Obese",
         School_Year == "Year 6") |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(tooltip = paste0(Year, "\n",
                          Ethnicity, "\n",
                          BMI_Category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)")) |> 
  ggplot(aes(x = Year,
             y = pct,
             col = Ethnicity)) +
  geom_line(aes(group = Ethnicity,
                text = tooltip),
            linewidth = 1) +
  geom_point(aes(text = tooltip),
                         #col = "white"
                         size = 2) +
  geom_errorbar(aes(ymin = lower_ci,
                    ymax = upper_ci),
                width = 0.2) +
  theme_classic() +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0),
                     #limits = c(8,22),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1)) +
  scale_colour_manual(values = c(bcc_colours),
                      name = "Ethnicity") +
  # scale_shape_manual(values = c(15, 16, 17, 18, 8, 4),
  #                    name = "Ethnicity") +
  ylab("Percentage of children") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

ggplotly(graph, tooltip = "text",
         height = 600) |> 
  config(modeBarButtonsToRemove = c('zoom', 'pan', 'select', 'zoomIn', 'zoomOut', 'lasso2d', 'autoScale', 'resetScale'),
         displaylogo = F)
```

## Overweight/Obese

**Figure 9h. Percentage of Year 6 children who are overweight or obese by ethnicity, over time**

Over the past ten years, prevalence of overweight and obesity has remained lower in children of White ethnicity than those of Asian, Black and Mixed ethnicities. However, prevalence of overweight and obesity in White children has increased in this time.

```{r trends_ethnicity_y6_obese_overweight}
#| warning: false
graph <- trends_by_ethnicity_by_school_year_3yrs |> 
  filter(BMI_Category == "Overweight/Obese",
         School_Year == "Year 6") |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(tooltip = paste0(Year, "\n",
                          Ethnicity, "\n",
                          BMI_Category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)")) |> 
  ggplot(aes(x = Year,
             y = pct,
             col = Ethnicity)) +
  geom_line(aes(group = Ethnicity,
                text = tooltip),
            linewidth = 1) +
  geom_point(aes(text = tooltip),
                         #col = "white"
                         size = 2) +
  geom_errorbar(aes(ymin = lower_ci,
                    ymax = upper_ci),
                width = 0.2) +
  theme_classic() +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0),
                     #limits = c(8,22),
                     #breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                     labels = scales::label_percent(scale = 1)) +
  scale_colour_manual(values = c(bcc_colours),
                      name = "Ethnicity") +
  # scale_shape_manual(values = c(15, 16, 17, 18, 8, 4),
  #                    name = "Ethnicity") +
  ylab("Percentage of children") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

ggplotly(graph, tooltip = "text",
         height = 600) |> 
  config(modeBarButtonsToRemove = c('zoom', 'pan', 'select', 'zoomIn', 'zoomOut', 'lasso2d', 'autoScale', 'resetScale'),
         displaylogo = F)
```
:::
:::::

## By Deprivation and Ethnicity

This section uses inequality matrices to examine the interaction of deprivation and ethnicity on BMI category. Looking at these categories in combination is important to better understand which groups are most at risk of overweight. Use the tabs to move between the figures.

::: {.callout-note .column-margin}
The heatmap shows the percentage of children in a group who fall into the relevant BMI category. The higher the proportion, the darker the tile. Groups with a prevalence which is significantly higher or lower than the Birmingham average are indicated with an up arrow (↑) or down arrow (↓) respectively. Groups with a prevalence statistically similar to the average are indicated with a dash (-).

Note that IDACI quintiles 3-5 have been combined into a single category to improve data robustness.
:::

::::: panel-tabset
## Reception

::: panel-tabset
## Underweight

**Figure 10a. Inequality matrix of deprivation and ethnicity, for percentage of Reception children who are underweight (`{r} periods_short[8]` period)**

Asian children at all levels of deprivation experience a higher prevalence of underweight than the Birmingham average. White children at all levels of deprivation, as well as children of Mixed and Other ethnicities in IDACI quintile 1, have a lower prevalence of underweight than average.

```{r ineq_mat_r_underweight}
#| warning: false
ineq_heatmap_interactive_mean(df = ncmp_data_period_8,
             year = periods[8],
             school_year = "Reception",
             category = "Underweight",
             white_text_threshold = 2.5,
             suppression_value = 7)
```

## Overweight

**Figure 10b. Inequality matrix of deprivation and ethnicity, for percentage of Reception children who are overweight (`{r} periods_short[8]` period)**

Asian children at all levels of deprivation experience a lower prevalence of overweight compared to the average. White children at all levels of deprivation, and Mixed ethnicity children in IDACI quintile 1, have a higher prevalence of overweight than average, with prevalence highest in the most deprived White children.

```{r ineq_mat_r_overweight}
#| warning: false
ineq_heatmap_interactive_mean(df = ncmp_data_period_8,
             year = periods[8],
             school_year = "Reception",
             category = "Overweight",
             white_text_threshold = 12,
             suppression_value = 7)
```

## Obese

**Figure 10c. Inequality matrix of deprivation and ethnicity, for percentage of Reception children who are obese (`{r} periods_short[8]` period)**

Prevalence of obesity is higher than the Birmingham average in Mixed and White children in quintile 1, and Black children in quintile 2. White and Asian children in the least deprived quintiles have lower prevalence of obesity than average. Black children in quintile 2 experience the highest prevalence of all groups.

```{r ineq_mat_r_obese}
#| warning: false
ineq_heatmap_interactive_mean(df = ncmp_data_period_8,
             year = periods[8],
             school_year = "Reception",
             category = "Obese",
             white_text_threshold = 12.5,
             suppression_value = 7)
```

## Overweight and Obese

**Figure 10d. Inequality matrix of deprivation and ethnicity, for percentage of Reception children who are overweight or obese (`{r} periods_short[8]` period)**

White children in IDACI quintiles 1 and 2 have higher prevalence of overweight and obesity than average. Black children in quintile 2, and Mixed ethnicity children in quintile 1, also have higher prevalence. Asian children at all levels of deprivation experience lower prevalence of overweight and obesity than average, as do children of White and Other ethnicities in the least deprived areas.

```{r ineq_mat_r_obese_overweight}
#| warning: false
ineq_heatmap_interactive_mean(df = ncmp_data_period_8 |> mutate(BMI_Category = case_when(BMI_Category == "Obese" ~ "Overweight/Obese",
                                                                             BMI_Category == "Overweight" ~ "Overweight/Obese",
                                                                             .default = BMI_Category)),
             year = periods[8],
             school_year = "Reception",
             category = "Overweight/Obese",
             white_text_threshold = 22,
             suppression_value = 7)
```
:::

## Year 6

::: panel-tabset
## Underweight

**Figure 10e. Inequality matrix of deprivation and ethnicity, for percentage of Year 6 children who are underweight (`{r} periods_short[8]` period)**

Asian children at all levels of deprivation experience a higher prevalence of underweight than the Birmingham average. White children at all levels of deprivation, as well as Black children in IDACI quintile 1, have a lower prevalence of underweight than average. The highest prevalence of underweight is seen in Asian children in quintiles 3-5.

```{r ineq_mat_y6_underweight}
#| warning: false
ineq_heatmap_interactive_mean(df = ncmp_data_period_8,
             year = periods[8],
             school_year = "Year 6",
             category = "Underweight",
             white_text_threshold = 2.5,
             suppression_value = 7)
```

## Overweight

**Figure 10f. Inequality matrix of deprivation and ethnicity, for percentage of Year 6 children who are overweight (`{r} periods_short[8]` period)**

Children of Mixed ethnicity experience lower prevalence of overweight than the Birmingham average. Almost all other groups do not differ from the average, though children of Unknown ethnicity do have higher prevalence of overweight.

```{r ineq_mat_y6_overweight}
#| warning: false
ineq_heatmap_interactive_mean(df = ncmp_data_period_8,
             year = periods[8],
             school_year = "Year 6",
             category = "Overweight",
             white_text_threshold = 13,
             suppression_value = 7)
```

## Obese

**Figure 10g. Inequality matrix of deprivation and ethnicity, for percentage of Year 6 children who are obese (`{r} periods_short[8]` period)**

Children of Asian, Black, White and Mixed ethnicities in IDACI quintile 1, as well as Black children in quintile 2, experience prevalence of obesity than the Birmingham average. Children of Asian, White and Other ethnicities in quintiles 3-5 have lower levels of obesity. Prevalence is highest in Black children in IDACI quintile 2.

```{r ineq_mat_y6_obese}
#| warning: false
ineq_heatmap_interactive_mean(df = ncmp_data_period_8,
             year = periods[8],
             school_year = "Year 6",
             category = "Obese",
             white_text_threshold = 27,
             suppression_value = 7)
```

## Overweight and Obese

**Figure 10h. Inequality matrix of deprivation and ethnicity, for percentage of Year 6 children who are overweight or obese (`{r} periods_short[8]` period)**

Prevalence of overweight and obesity is higher than average in children of Asian, Black, White and Mixed ethnicities in IDACI quintile 1, and in Black children in quintile 2. Children of Asian, Black and Other ethnicities in quintiles 3-5, and White children in quintile 2, have lower prevalence. Prevalence of overweight and obesity is highest in Black children in IDACI quintile 2.

```{r ineq_mat_y6_obese_overweight}
#| warning: false
ineq_heatmap_interactive_mean(df = ncmp_data_period_8 |> mutate(BMI_Category = case_when(BMI_Category == "Obese" ~ "Overweight/Obese",
                                                                             BMI_Category == "Overweight" ~ "Overweight/Obese",
                                                                             .default = BMI_Category)),
             year = periods[8],
             school_year = "Year 6",
             category = "Overweight/Obese",
             white_text_threshold = 41,
             suppression_value = 7)
```
:::
:::::

## By Geography

This section looks at how prevalence of overweight and obesity is distributed geographically using interactive maps.

```{r map_setup}
# Data Import -------------------------------------------------------------

# MSOAs
birmingham_msoa <- read_sf("C:/Users/bccaengs/OneDrive - Birmingham City Council/Documents/Work/Useful datasets/Shape files/birmingham_msoa_2021.geojson")
msoa_name_lookup <- read.csv("C:/Users/bccaengs/OneDrive - Birmingham City Council/Documents/Work/Useful datasets/msoa_name_lookup.csv") |> 
  select(msoa21cd, msoa21nm, msoa21hclnm)
 
# Wards
birmingham_wards <- read_sf("C:/Users/bccaengs/OneDrive - Birmingham City Council/Documents/Work/Useful datasets/Shape files/birmingham_wards.geo.json")

# Constituencies
birmingham_con <- read_sf("C:/Users/bccaengs/OneDrive - Birmingham City Council/Documents/Work/Useful datasets/Shape files/birmingham_constituencies_2024.geojson")

# import schools data

bham_schools <- read.csv("C:/Users/bccaengs/OneDrive - Birmingham City Council/Documents/Work/Useful datasets/all_uk_schools_20250312.csv") |> 
  filter(`LA..name.` == "Birmingham",
         `EstablishmentStatus..name.` == "Open") |> 
  select(URN, EstablishmentName, `TypeOfEstablishment..name.`, `EstablishmentTypeGroup..name.`,
         `PhaseOfEducation..name.`, StatutoryLowAge, StatutoryHighAge,
         Easting, Northing)

#convert eastings and northings to sf object with lat and long
bham_schools <- bham_schools |>
  filter(!is.na(Easting)) |> 
  filter(!is.na(Northing)) |> 
  st_as_sf(coords = c("Easting", "Northing"), crs = 27700) |> 
  st_transform(4326)

# get df of primary schools only

bham_primary_schools <- bham_schools |> 
  filter(`PhaseOfEducation..name.` == "Primary")

# Data analysis -----------------------------------------------------------

# MSOAs
# calculate number of overweight/obese children by msoa and school year, and calculate denominator (children per msoa by school year)
obese_overweight_by_msoa_by_school_year <- ncmp_data_period_8 |> 
  mutate(BMI_Category = case_when(BMI_Category == "Obese" ~ "Overweight/Obese",
                                  BMI_Category == "Overweight" ~ "Overweight/Obese",
                                  .default = BMI_Category)) |> 
  group_by(MSOA21CD, BMI_Category, School_Year) |> 
  count(name = "count") |> 
  ungroup() |> 
  group_by(MSOA21CD, School_Year) |> 
  mutate(denominator = sum(count)) |> 
  filter(BMI_Category == "Overweight/Obese")

# calculate % of Overweight/Obese incl confidence intervals
obese_overweight_by_msoa_by_school_year <- wilson_ci(obese_overweight_by_msoa_by_school_year,
                                                           obese_overweight_by_msoa_by_school_year$count,
                                                           obese_overweight_by_msoa_by_school_year$denominator)

# add geojson info
obese_overweight_by_msoa_by_school_year <- right_join(birmingham_msoa, obese_overweight_by_msoa_by_school_year,
                                                            by = join_by(msoa21cd == MSOA21CD))

# add MSOA names
obese_overweight_by_msoa_by_school_year <- left_join(obese_overweight_by_msoa_by_school_year, msoa_name_lookup,
                                                           by = c("msoa21nm", "msoa21cd"))

# create separate dataframes for reception and year 6
obese_overweight_by_msoa_reception <- obese_overweight_by_msoa_by_school_year |> 
  filter(School_Year == "Reception") |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(D = pct - obese_overweight_all_birmingham_r_pct,
         D_lower = D - sqrt((pct - lower_ci)^2 + (obese_overweight_all_birmingham_r_upper_ci - obese_overweight_all_birmingham_r_pct)^2),
         D_upper = D + sqrt((pct - lower_ci)^2 + (obese_overweight_all_birmingham_r_upper_ci - obese_overweight_all_birmingham_r_pct)^2),
         sig_diff_test = case_when(D_lower < 0 & D_upper < 0 ~ "sig",
                                   D_lower > 0 & D_upper > 0 ~ "sig",
                                   .default = "not sig"),
         sig_diff_new = case_when(sig_diff_test == "sig" & pct > obese_overweight_all_birmingham_r_pct ~ "Significantly higher than Birmingham average",
                                  sig_diff_test == "sig" & pct < obese_overweight_all_birmingham_r_pct ~ "Significantly lower than Birmingham average",
                                  .default = "No significant difference to Birmingham average")) |> 
  mutate(sig_diff_new = factor(sig_diff_new,
                               levels = c("Significantly higher than Birmingham average", 
                                          "No significant difference to Birmingham average",
                                          "Significantly lower than Birmingham average")))

obese_overweight_by_msoa_y6 <- obese_overweight_by_msoa_by_school_year |> 
  filter(School_Year == "Year 6") |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(D = pct - obese_overweight_all_birmingham_y6_pct,
         D_lower = D - sqrt((pct - lower_ci)^2 + (obese_overweight_all_birmingham_y6_upper_ci - obese_overweight_all_birmingham_y6_pct)^2),
         D_upper = D + sqrt((pct - lower_ci)^2 + (obese_overweight_all_birmingham_y6_upper_ci - obese_overweight_all_birmingham_y6_pct)^2),
         sig_diff_test = case_when(D_lower < 0 & D_upper < 0 ~ "sig",
                                   D_lower > 0 & D_upper > 0 ~ "sig",
                                   .default = "not sig"),
         sig_diff_new = case_when(sig_diff_test == "sig" & pct > obese_overweight_all_birmingham_y6_pct ~ "Significantly higher than Birmingham average",
                                  sig_diff_test == "sig" & pct < obese_overweight_all_birmingham_y6_pct ~ "Significantly lower than Birmingham average",
                                  .default = "No significant difference to Birmingham average")) |> 
  mutate(sig_diff_new = factor(sig_diff_new,
                               levels = c("Significantly higher than Birmingham average", 
                                          "No significant difference to Birmingham average",
                                          "Significantly lower than Birmingham average")))

# Wards
# calculate number of overweight/obese children by ward and school year, and calculate denominator (children per ward by school year)
obese_overweight_by_ward_by_school_year <- ncmp_data_period_8 |> 
  mutate(BMI_Category = case_when(BMI_Category == "Obese" ~ "Overweight/Obese",
                                  BMI_Category == "Overweight" ~ "Overweight/Obese",
                                  .default = BMI_Category)) |> 
  group_by(WD18CD, WD18NM, BMI_Category, School_Year) |> 
  count(name = "count") |> 
  ungroup() |> 
  group_by(WD18CD, WD18NM, School_Year) |> 
  mutate(denominator = sum(count)) |> 
  filter(BMI_Category == "Overweight/Obese")

# calculate % of Overweight/Obese incl confidence intervals
obese_overweight_by_ward_by_school_year <- wilson_ci(obese_overweight_by_ward_by_school_year,
                                                           obese_overweight_by_ward_by_school_year$count,
                                                           obese_overweight_by_ward_by_school_year$denominator)

# add geojson info
obese_overweight_by_ward_by_school_year <- right_join(birmingham_wards, obese_overweight_by_ward_by_school_year,
                                                            by = join_by(WD18CD, WARDNAME == WD18NM))

# create separate dataframes for reception and year 6
obese_overweight_by_ward_reception <- obese_overweight_by_ward_by_school_year |> 
  filter(School_Year == "Reception") |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(D = pct - obese_overweight_all_birmingham_r_pct,
         D_lower = D - sqrt((pct - lower_ci)^2 + (obese_overweight_all_birmingham_r_upper_ci - obese_overweight_all_birmingham_r_pct)^2),
         D_upper = D + sqrt((pct - lower_ci)^2 + (obese_overweight_all_birmingham_r_upper_ci - obese_overweight_all_birmingham_r_pct)^2),
         sig_diff_test = case_when(D_lower < 0 & D_upper < 0 ~ "sig",
                                   D_lower > 0 & D_upper > 0 ~ "sig",
                                   .default = "not sig"),
         sig_diff_new = case_when(sig_diff_test == "sig" & pct > obese_overweight_all_birmingham_r_pct ~ "Significantly higher than Birmingham average",
                                  sig_diff_test == "sig" & pct < obese_overweight_all_birmingham_r_pct ~ "Significantly lower than Birmingham average",
                                  .default = "No significant difference to Birmingham average")) |> 
  mutate(sig_diff_new = factor(sig_diff_new,
                               levels = c("Significantly higher than Birmingham average", 
                                          "No significant difference to Birmingham average",
                                          "Significantly lower than Birmingham average")))

obese_overweight_by_ward_y6 <- obese_overweight_by_ward_by_school_year |> 
  filter(School_Year == "Year 6") |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(D = pct - obese_overweight_all_birmingham_y6_pct,
         D_lower = D - sqrt((pct - lower_ci)^2 + (obese_overweight_all_birmingham_y6_upper_ci - obese_overweight_all_birmingham_y6_pct)^2),
         D_upper = D + sqrt((pct - lower_ci)^2 + (obese_overweight_all_birmingham_y6_upper_ci - obese_overweight_all_birmingham_y6_pct)^2),
         sig_diff_test = case_when(D_lower < 0 & D_upper < 0 ~ "sig",
                                   D_lower > 0 & D_upper > 0 ~ "sig",
                                   .default = "not sig"),
         sig_diff_new = case_when(sig_diff_test == "sig" & pct > obese_overweight_all_birmingham_y6_pct ~ "Significantly higher than Birmingham average",
                                  sig_diff_test == "sig" & pct < obese_overweight_all_birmingham_y6_pct ~ "Significantly lower than Birmingham average",
                                  .default = "No significant difference to Birmingham average")) |> 
  mutate(sig_diff_new = factor(sig_diff_new,
                               levels = c("Significantly higher than Birmingham average", 
                                          "No significant difference to Birmingham average",
                                          "Significantly lower than Birmingham average")))
# Constituencies

# calculate number of overweight/obese children by constituency and school year, and calculate denominator (children per msoa by school year)
obese_overweight_by_con_by_school_year <- ncmp_data_period_8 |> 
  rename(PCON24CD = `Westminster Parliamentary constituency`) |> 
  mutate(BMI_Category = case_when(BMI_Category == "Obese" ~ "Overweight/Obese",
                                  BMI_Category == "Overweight" ~ "Overweight/Obese",
                                  .default = BMI_Category)) |> 
  group_by(PCON24CD, BMI_Category, School_Year) |> 
  count(name = "count") |> 
  ungroup() |> 
  group_by(PCON24CD, School_Year) |> 
  mutate(denominator = sum(count)) |> 
  filter(BMI_Category == "Overweight/Obese")

# calculate % of Overweight/Obese incl confidence intervals
obese_overweight_by_con_by_school_year <- wilson_ci(obese_overweight_by_con_by_school_year,
                                                           obese_overweight_by_con_by_school_year$count,
                                                           obese_overweight_by_con_by_school_year$denominator)

# add geojson info
obese_overweight_by_con_by_school_year <- right_join(birmingham_con, obese_overweight_by_con_by_school_year,
                                                            by = join_by(PCON24CD == PCON24CD))

# create separate dataframes for reception and year 6
obese_overweight_by_con_reception <- obese_overweight_by_con_by_school_year |> 
  filter(School_Year == "Reception") |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(D = pct - obese_overweight_all_birmingham_r_pct,
         D_lower = D - sqrt((pct - lower_ci)^2 + (obese_overweight_all_birmingham_r_upper_ci - obese_overweight_all_birmingham_r_pct)^2),
         D_upper = D + sqrt((pct - lower_ci)^2 + (obese_overweight_all_birmingham_r_upper_ci - obese_overweight_all_birmingham_r_pct)^2),
         sig_diff_test = case_when(D_lower < 0 & D_upper < 0 ~ "sig",
                                   D_lower > 0 & D_upper > 0 ~ "sig",
                                   .default = "not sig"),
         sig_diff_new = case_when(sig_diff_test == "sig" & pct > obese_overweight_all_birmingham_r_pct ~ "Significantly higher than Birmingham average",
                                  sig_diff_test == "sig" & pct < obese_overweight_all_birmingham_r_pct ~ "Significantly lower than Birmingham average",
                                  .default = "No significant difference to Birmingham average")) |> 
  mutate(sig_diff_new = factor(sig_diff_new,
                               levels = c("Significantly higher than Birmingham average", 
                                          "No significant difference to Birmingham average",
                                          "Significantly lower than Birmingham average")))

obese_overweight_by_con_y6 <- obese_overweight_by_con_by_school_year |> 
  filter(School_Year == "Year 6") |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(D = pct - obese_overweight_all_birmingham_y6_pct,
         D_lower = D - sqrt((pct - lower_ci)^2 + (obese_overweight_all_birmingham_y6_upper_ci - obese_overweight_all_birmingham_y6_pct)^2),
         D_upper = D + sqrt((pct - lower_ci)^2 + (obese_overweight_all_birmingham_y6_upper_ci - obese_overweight_all_birmingham_y6_pct)^2),
         sig_diff_test = case_when(D_lower < 0 & D_upper < 0 ~ "sig",
                                   D_lower > 0 & D_upper > 0 ~ "sig",
                                   .default = "not sig"),
         sig_diff_new = case_when(sig_diff_test == "sig" & pct > obese_overweight_all_birmingham_y6_pct ~ "Significantly higher than Birmingham average",
                                  sig_diff_test == "sig" & pct < obese_overweight_all_birmingham_y6_pct ~ "Significantly lower than Birmingham average",
                                  .default = "No significant difference to Birmingham average")) |> 
  mutate(sig_diff_new = factor(sig_diff_new,
                               levels = c("Significantly higher than Birmingham average", 
                                          "No significant difference to Birmingham average",
                                          "Significantly lower than Birmingham average")))

# Set up for maps -------------------------------------------

# MSOA - set up colour palettes for reception and year 6 (heatmap)
pal_msoa_r <- colorNumeric(palette = "RdPu",
                      domain = obese_overweight_by_msoa_reception$pct)
pal_msoa_y6 <- colorNumeric(palette = "RdPu",
                    domain = obese_overweight_by_msoa_y6$pct)

# MSOA - set up colour palettes for reception and year 6 (sig diff)
sig_diff_colours <- c("#fee08b", "#fc8d59", "#91cf60")

pal_msoa_r_cat <- colorFactor(palette = c("#fc8d59", "#fee08b", "#91cf60"),
                              domain = obese_overweight_by_msoa_reception$sig_diff_new)
pal_msoa_y6_cat <- colorFactor(palette = c("#fc8d59", "#fee08b", "#91cf60"),
                              domain = obese_overweight_by_msoa_y6$sig_diff_new)

# MSOA - set up labels for reception and year 6
labels_msoa_r <- paste(obese_overweight_by_msoa_reception$msoa21hclnm, "<br/>",
                  round(obese_overweight_by_msoa_reception$pct, 1), "% overweight/obese", "<br/>",
                  obese_overweight_by_msoa_reception$sig_diff_new,
                  sep = "") |> 
  lapply(htmltools::HTML)

labels_msoa_y6 <- paste(obese_overweight_by_msoa_y6$msoa21hclnm, "<br/>",
                   round(obese_overweight_by_msoa_y6$pct, 1), "% overweight/obese", "<br/>",
                   obese_overweight_by_msoa_y6$sig_diff_new,
                   sep = "") |> 
  lapply(htmltools::HTML)

# WARD - set up colour palettes for reception and year 6 (heatmap)
pal_ward_r <- colorNumeric(palette = "RdPu",
                           domain = obese_overweight_by_ward_reception$pct)
pal_ward_y6 <- colorNumeric(palette = "RdPu",
                            domain = obese_overweight_by_ward_y6$pct)

# WARD - set up colour palettes for reception and year 6 (sig diff)
pal_ward_r_cat <- colorFactor(palette = c("#fc8d59", "#fee08b", "#91cf60"),
                              domain = obese_overweight_by_ward_reception$sig_diff_new)
pal_ward_y6_cat <- colorFactor(palette = c("#fc8d59", "#fee08b", "#91cf60"),
                               domain = obese_overweight_by_ward_y6$sig_diff_new)

# WARD - set up labels for reception and year 6
labels_ward_r <- paste(obese_overweight_by_ward_reception$WARDNAME, "<br/>",
                       round(obese_overweight_by_ward_reception$pct, 1), "% overweight/obese", "<br/>",
                       obese_overweight_by_ward_reception$sig_diff_new,
                       sep = "") |> 
  lapply(htmltools::HTML)

labels_ward_y6 <- paste(obese_overweight_by_ward_y6$WARDNAME, "<br/>",
                        round(obese_overweight_by_ward_y6$pct, 1), "% overweight/obese: ", "<br/>",
                        obese_overweight_by_ward_y6$sig_diff_new,
                        sep = "") |> 
  lapply(htmltools::HTML)

# CONSTITUENCY - set up colour palettes for reception and year 6 (heatmap)
pal_con_r <- colorNumeric(palette = "RdPu",
                           domain = obese_overweight_by_con_reception$pct)
pal_con_y6 <- colorNumeric(palette = "RdPu",
                            domain = obese_overweight_by_con_y6$pct)

# CONSTITUENCY - set up colour palettes for reception and year 6 (sig diff)
pal_con_r_cat <- colorFactor(palette = c("#fc8d59", "#fee08b", "#91cf60"),
                              domain = obese_overweight_by_con_reception$sig_diff_new)
pal_con_y6_cat <- colorFactor(palette = c("#fc8d59", "#fee08b", "#91cf60"),
                               domain = obese_overweight_by_con_y6$sig_diff_new)

# CONSTITUENCY - set up labels for reception and year 6
labels_con_r <- paste(obese_overweight_by_con_reception$PCON24NM, "<br/>",
                       round(obese_overweight_by_con_reception$pct, 1), "% overweight/obese", "<br/>",
                       obese_overweight_by_con_reception$sig_diff_new,
                       sep = "") |> 
  lapply(htmltools::HTML)

labels_con_y6 <- paste(obese_overweight_by_con_y6$PCON24NM, "<br/>",
                        round(obese_overweight_by_con_y6$pct, 1), "% overweight/obese: ", "<br/>",
                        obese_overweight_by_con_y6$sig_diff_new,
                        sep = "") |> 
  lapply(htmltools::HTML)
```

### Overweight/Obese Prevalence - Heatmap

Figures 11a and 11b show how prevalence of overweight and obesity varies across the city. A darker colour indicates a higher prevalence of overweight and obesity in that area. Use the tabs to move between the figures.

The boundaries of the MSOAs, wards and parliamentary constituencies visualised in these maps are not coterminous (i.e. they do not overlap perfectly). As a result, constituencies should only be compared with constituencies, wards with wards and so on.

::: {.callout-note .column-margin}
To explore the map, zoom in and out with the zoom buttons at the top left. The locations of primary schools are marked - hover over a marker to see the name of the school, or remove the markers by unticking the layer in the box in the top right. This box also allows the user to choose whether prevalence is mapped by MSOA, electoral ward or parliamentary constituency (also known as districts).
:::

::: panel-tabset
## Reception

**Figure 11a. Percentage of Reception children who are overweight or obese, by MSOA/ward/constituency (`{r} periods_short[8]` period)**

```{r obese_overweight_heatmap_r}
#| warning: false
#| out-height: 700px
#| out-width: 860px

leaflet(sizingPolicy = leafletSizingPolicy(knitr.defaultHeight = 800)) |> 
  addTiles(options = tileOptions(opacity = 0)) |> 
  addPolygons(data = obese_overweight_by_msoa_reception,
              fillColor = ~pal_msoa_r(pct),
              #stroke = F,
              fillOpacity = 1,
              smoothFactor = 0.2,
              color = "white",
              weight = 1,
              opacity = 1,
              highlightOptions = highlightOptions(
                weight = 2,
                color = "#666",
                bringToFront = TRUE),
              label = labels_msoa_r,
              labelOptions = labelOptions(style = list("font-size" = "14px")),
              group = "MSOA") |> 
  addPolygons(data = obese_overweight_by_ward_reception,
              fillColor = ~pal_ward_r(pct),
              #stroke = F,
              fillOpacity = 1,
              smoothFactor = 0.2,
              color = "white",
              weight = 1,
              opacity = 1,
              highlightOptions = highlightOptions(
                weight = 2,
                color = "#666",
                bringToFront = TRUE),
              label = labels_ward_r,
              labelOptions = labelOptions(style = list("font-size" = "14px")),
              group = "Ward") |>
  addPolygons(data = obese_overweight_by_con_reception,
              fillColor = ~pal_con_r(pct),
              #stroke = F,
              fillOpacity = 1,
              smoothFactor = 0.2,
              color = "white",
              weight = 1,
              opacity = 1,
              highlightOptions = highlightOptions(
                weight = 2,
                color = "#666",
                bringToFront = TRUE),
              label = labels_con_r,
              labelOptions = labelOptions(style = list("font-size" = "14px")),
              group = "Constituency") |>
  addMarkers(data = bham_primary_schools,
             popup = ~as.character(EstablishmentName),
             label = ~as.character(EstablishmentName),
             group = "Primary Schools",
             clusterOptions = markerClusterOptions(showCoverageOnHover = FALSE)) |> 
  addLayersControl(baseGroups = c("MSOA", "Ward", "Constituency"),
                   overlayGroups = c("Primary Schools"),
                   options = layersControlOptions(collapsed = FALSE))
```

## Year 6

**Figure 11a. Percentage of Year 6 children who are overweight or obese, by MSOA/ward/constituency (`{r} periods_short[8]` period)**

```{r obese_overweight_heatmap_y6}
#| warning: false
#| out-height: 700px
#| out-width: 860px
leaflet(sizingPolicy = leafletSizingPolicy(knitr.defaultHeight = 800)) |> 
  addTiles(options = tileOptions(opacity = 0)) |> 
  addPolygons(data = obese_overweight_by_msoa_y6,
              fillColor = ~pal_msoa_y6(pct),
              #stroke = F,
              fillOpacity = 1,
              smoothFactor = 0.2,
              color = "white",
              weight = 1,
              opacity = 1,
              highlightOptions = highlightOptions(
                weight = 2,
                color = "#666",
                bringToFront = TRUE),
              label = labels_msoa_y6,
              labelOptions = labelOptions(style = list("font-size" = "14px")),
              group = "MSOA") |> 
  addPolygons(data = obese_overweight_by_ward_y6,
              fillColor = ~pal_ward_y6(pct),
              #stroke = F,
              fillOpacity = 1,
              smoothFactor = 0.2,
              color = "white",
              weight = 1,
              opacity = 1,
              highlightOptions = highlightOptions(
                weight = 2,
                color = "#666",
                bringToFront = TRUE),
              label = labels_ward_y6,
              labelOptions = labelOptions(style = list("font-size" = "14px")),
              group = "Ward") |>
  addPolygons(data = obese_overweight_by_con_y6,
              fillColor = ~pal_con_y6(pct),
              #stroke = F,
              fillOpacity = 1,
              smoothFactor = 0.2,
              color = "white",
              weight = 1,
              opacity = 1,
              highlightOptions = highlightOptions(
                weight = 2,
                color = "#666",
                bringToFront = TRUE),
              label = labels_con_y6,
              labelOptions = labelOptions(style = list("font-size" = "14px")),
              group = "Constituency") |>
  addMarkers(data = bham_primary_schools,
             popup = ~as.character(EstablishmentName),
             label = ~as.character(EstablishmentName),
             group = "Primary Schools",
             clusterOptions = markerClusterOptions(showCoverageOnHover = FALSE)) |> 
  addLayersControl(baseGroups = c("MSOA", "Ward", "Constituency"),
                   overlayGroups = c("Primary Schools"),
                   options = layersControlOptions(collapsed = FALSE))
```
:::

### Overweight/Obese Prevalence - Significance Map

Figures 12a and 12b show how prevalence of overweight and obesity varies across the city. Areas are colour-coded to indicate whether prevalence is higher (orange), similar to (yellow) or lower (green) than the Birmingham average. Use the tabs to move between the figures.

The boundaries of the MSOAs, wards and parliamentary constituencies visualised in these maps are not coterminous (i.e. they do not overlap perfectly). As a result, constituencies should only be compared with constituencies, wards with wards and so on.

::: {.callout-note .column-margin}
To explore the map, zoom in and out with the zoom buttons at the top left. The locations of primary schools are marked - hover over a marker to see the name of the school, or remove the markers by unticking the layer in the box in the top right. This box also allows the user to choose whether prevalence is mapped by MSOA, electoral ward or parliamentary constituency (also known as districts).
:::

::: panel-tabset
## Reception

**Figure 12a. Percentage of Reception children who are overweight or obese, by MSOA/ward/constituency (`{r} periods_short[8]` period)**

N.B. The Birmingham average for Reception is `{r} round(obese_overweight_all_birmingham_r_pct, 1)`%.

```{r obese_overweight_sig_map_r}
#| warning: false
#| out-height: 700px
#| out-width: 860px
leaflet(sizingPolicy = leafletSizingPolicy(knitr.defaultHeight = 500)) |> 
  addTiles(options = tileOptions(opacity = 0)) |> 
  addPolygons(data = obese_overweight_by_ward_reception,
              fillColor = ~pal_ward_r_cat(sig_diff_new),
              #stroke = F,
              fillOpacity = 1,
              smoothFactor = 0.2,
              color = "white",
              weight = 1,
              opacity = 1,
              highlightOptions = highlightOptions(
                weight = 2,
                color = "#666",
                bringToFront = TRUE),
              label = labels_ward_r,
              labelOptions = labelOptions(style = list("font-size" = "14px")),
              group = "Ward") |>
  addPolygons(data = obese_overweight_by_msoa_reception,
              fillColor = ~pal_msoa_r_cat(sig_diff_new),
              #stroke = F,
              fillOpacity = 1,
              smoothFactor = 0.2,
              color = "white",
              weight = 1,
              opacity = 1,
              highlightOptions = highlightOptions(
                weight = 2,
                color = "#666",
                bringToFront = TRUE),
              label = labels_msoa_r,
              labelOptions = labelOptions(style = list("font-size" = "14px")),
              group = "MSOA") |> 
  addPolygons(data = obese_overweight_by_con_reception,
              fillColor = ~pal_con_r_cat(sig_diff_new),
              #stroke = F,
              fillOpacity = 1,
              smoothFactor = 0.2,
              color = "white",
              weight = 1,
              opacity = 1,
              highlightOptions = highlightOptions(
                weight = 2,
                color = "#666",
                bringToFront = TRUE),
              label = labels_con_r,
              labelOptions = labelOptions(style = list("font-size" = "14px")),
              group = "Constituency") |> 
  addMarkers(data = bham_primary_schools,
             popup = ~as.character(EstablishmentName),
             label = ~as.character(EstablishmentName),
             group = "Primary Schools",
             clusterOptions = markerClusterOptions(showCoverageOnHover = FALSE)) |> 
  addLegend(data = obese_overweight_by_msoa_reception,
            pal = pal_msoa_r_cat,
            values = ~sig_diff_new,
            title = "",
            position = "bottomright",
            #labFormat = labelFormat(transform = function(x) str_wrap(x, width = 10)),
            opacity = 0.9) |>
  addLayersControl(baseGroups = c("MSOA", "Ward", "Constituency"),
                   overlayGroups = c("Primary Schools"),
                   options = layersControlOptions(collapsed = FALSE))
```

## Year 6

**Figure 13b. Percentage of Year 6 children who are overweight or obese, by MSOA/ward/constituency (`{r} periods_short[8]` period)**

N.B. The Birmingham average for Year 6 is `{r} round(obese_overweight_all_birmingham_y6_pct, 1)`%.

```{r obese_overweight_sig_map_y6}
#| warning: false
#| out-height: 700px
#| out-width: 860px
leaflet(sizingPolicy = leafletSizingPolicy(knitr.defaultHeight = 500)) |> 
  addTiles(options = tileOptions(opacity = 0)) |> 
  addPolygons(data = obese_overweight_by_ward_y6,
              fillColor = ~pal_ward_y6_cat(sig_diff_new),
              #stroke = F,
              fillOpacity = 1,
              smoothFactor = 0.2,
              color = "white",
              weight = 1,
              opacity = 1,
              highlightOptions = highlightOptions(
                weight = 2,
                color = "#666",
                bringToFront = TRUE),
              label = labels_ward_y6,
              labelOptions = labelOptions(style = list("font-size" = "14px")),
              group = "Ward") |>
  addPolygons(data = obese_overweight_by_msoa_y6,
              fillColor = ~pal_msoa_y6_cat(sig_diff_new),
              #stroke = F,
              fillOpacity = 1,
              smoothFactor = 0.2,
              color = "white",
              weight = 1,
              opacity = 1,
              highlightOptions = highlightOptions(
                weight = 2,
                color = "#666",
                bringToFront = TRUE),
              label = labels_msoa_y6,
              labelOptions = labelOptions(style = list("font-size" = "14px")),
              group = "MSOA") |> 
  addPolygons(data = obese_overweight_by_con_y6,
              fillColor = ~pal_con_y6_cat(sig_diff_new),
              #stroke = F,
              fillOpacity = 1,
              smoothFactor = 0.2,
              color = "white",
              weight = 1,
              opacity = 1,
              highlightOptions = highlightOptions(
                weight = 2,
                color = "#666",
                bringToFront = TRUE),
              label = labels_con_y6,
              labelOptions = labelOptions(style = list("font-size" = "14px")),
              group = "Constituency") |> 
  addMarkers(data = bham_primary_schools,
             popup = ~as.character(EstablishmentName),
             label = ~as.character(EstablishmentName),
             group = "Primary Schools",
             clusterOptions = markerClusterOptions(showCoverageOnHover = FALSE)) |> 
  addLegend(data = obese_overweight_by_msoa_reception,
            pal = pal_msoa_r_cat,
            values = ~sig_diff_new,
            title = "",
            position = "bottomright",
            #labFormat = labelFormat(transform = function(x) str_wrap(x, width = 10)),
            opacity = 0.9) |>
  addLayersControl(baseGroups = c("MSOA", "Ward", "Constituency"),
                   overlayGroups = c("Primary Schools"),
                   options = layersControlOptions(collapsed = FALSE))
```
:::

# Changes in BMI Category

This section presents analysis looking at how children have moved between BMI categories from Reception to Year 6.

The NCMP dataset contains information such as name, NHS number and date of birth which allow a child's Reception measurement to be linked to their subsequent measurement in Year 6. Because the analysis tracks individual children, clinical BMI thresholds were used to assign BMI category. As a result, the proportions of children in each BMI category will differ from the population level prevalence estimates presented elsewhere in this analysis.

This analysis combines data from three cohorts of children to ensure estimates are robust:

-   Children measured in Reception in 2014/15, and in Year 6 in 2021/22
-   Children measured in Reception in 2015/16, and in Year 6 in 2022/23
-   Children measured in Reception in 2016/17, and in Year 6 in 2023/24

```{r cohort_analysis_data_import}
#| warning: false
#| output: false

# get merged tables for 2015-22, 2016-23 and 2017-24 cohorts from SQL
# allows merging using NHS number/DOB or Forename/Surname/DOB as described in OHID methodology
str_sql_NCMP_cohort_17_24 <- "SELECT *
FROM [PH_Evelyn].[dbo].[NCMP_2017_2024_cohort]"

str_sql_NCMP_cohort_16_23 <- "SELECT *
FROM [PH_Evelyn].[dbo].[NCMP_2016_2023_cohort]"

str_sql_NCMP_cohort_15_22 <- "SELECT *
FROM [PH_Evelyn].[dbo].[NCMP_2015_2022_cohort]"

cohort_17_24 <- DBI::dbGetQuery(conpool, str_sql_NCMP_cohort_17_24)

cohort_16_23 <- DBI::dbGetQuery(conpool, str_sql_NCMP_cohort_16_23)

cohort_15_22 <- DBI::dbGetQuery(conpool, str_sql_NCMP_cohort_15_22)

#bind dfs together into one
cohorts_combined <- bind_rows(cohort_15_22,
                              cohort_16_23,
                              cohort_17_24)

# 38,101 records total

# Cohort dataset cleaning and manipulation ----------------------------------

# add IDACI decile and quintile by merging on LSOA11CD
cohorts_combined <- cohorts_combined |> 
  left_join(IDACI_quintiles,
            by = "LSOA11CD")

# filter non-measurement rows out of main df (removes 1582 records)
cohorts_combined <- cohorts_combined |> 
  filter(!is.na(BMI_Category_Clinical_r)) |> 
  filter(!is.na(BMI_Category_Clinical_y6))

# change values in some fields
cohorts_combined <- cohorts_combined |> 
  mutate(Gender_r = case_when(Gender_r == "M" ~ "Male",
                              Gender_r == "F" ~ "Female"),
         Gender_y6 = case_when(Gender_y6 == "M" ~ "Male",
                               Gender_y6 == "F" ~ "Female"),
         School_Year_r = case_when(School_Year_r == "Year 0" ~ "Reception",
                                   School_Year_r == "Year 6" ~ "Year 6"),
         School_Year_y6 = case_when(School_Year_y6 == "Year 0" ~ "Reception",
                                    School_Year_y6 == "Year 6" ~ "Year 6"),
         BMI_Category_Clinical_r = case_when(BMI_Category_Clinical_r == "underweight" ~ "Underweight",
                                             BMI_Category_Clinical_r == "healthy weight" ~ "Healthy Weight",
                                             BMI_Category_Clinical_r == "overweight" ~ "Overweight",
                                             BMI_Category_Clinical_r == "very overweight" ~ "Obese"),
         BMI_Category_Clinical_Grouped_r = case_when(BMI_Category_Clinical_Grouped_r == "underweight" ~ "Underweight",
                                                     BMI_Category_Clinical_Grouped_r == "healthy weight" ~ "Healthy Weight",
                                                     BMI_Category_Clinical_Grouped_r == "overweight or very overweight" ~ "Overweight/Obese"),
         BMI_Category_Clinical_y6 = case_when(BMI_Category_Clinical_y6 == "underweight" ~ "Underweight",
                                              BMI_Category_Clinical_y6 == "healthy weight" ~ "Healthy Weight",
                                              BMI_Category_Clinical_y6 == "overweight" ~ "Overweight",
                                              BMI_Category_Clinical_y6 == "very overweight" ~ "Obese"),
         BMI_Category_Clinical_Grouped_y6 = case_when(BMI_Category_Clinical_Grouped_y6 == "underweight" ~ "Underweight",
                                                      BMI_Category_Clinical_Grouped_y6 == "healthy weight" ~ "Healthy Weight",
                                                      BMI_Category_Clinical_Grouped_y6 == "overweight or very overweight" ~ "Overweight/Obese"))

# check Ethnicity values
cohorts_combined |> 
  group_by(Ethnicity_r) |> 
  count()

# merge/rename some ethnicities to give Asian, Black, Mixed, Unknown, White, Other
cohorts_combined <- cohorts_combined |> 
  mutate(Ethnicity_r = case_when(is.na(Ethnicity_r) ~ "Unknown",
                                 Ethnicity_r == "Chinese" ~ "Asian",
                                 Ethnicity_r == "Not stated" ~ "Unknown",
                                 Ethnicity_r == "Any other ethnic group" ~ "Other",
                                 .default = Ethnicity_r)) |> 
  mutate(Ethnicity_r = str_trim(Ethnicity_r))

cohorts_combined <- cohorts_combined |> 
  mutate(Ethnicity_y6 = case_when(is.na(Ethnicity_y6) ~ "Unknown",
                                  Ethnicity_y6 == "Chinese" ~ "Asian",
                                  Ethnicity_y6 == "Not stated" ~ "Unknown",
                                  Ethnicity_y6 == "Any other ethnic group" ~ "Other",
                                  .default = Ethnicity_y6)) |> 
  mutate(Ethnicity_y6 = str_trim(Ethnicity_y6))

# factorise imd scores
cohorts_combined <- cohorts_combined |> 
  mutate(IDACI_2019_Decile = factor(IDACI_2019_Decile,
                                    levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10")),
         IDACI_2019_Quintile = factor(IDACI_2019_Quintile,
                                      levels = c("1", "2", "3", "4", "5")))

# add short stature column based on height_p
cohorts_combined <- cohorts_combined |> 
  mutate(short_stature_r = case_when(Height_p_r <= 0.02 ~ TRUE,
                                     .default = FALSE),
         short_stature_y6 = case_when(Height_p_y6 <= 0.02 ~ TRUE,
                                      .default = FALSE))

# currently have 36,817 records

# remove records where recorded gender is different between reception and year 6
cohorts_combined <- cohorts_combined |>
  mutate(sex_same = case_when(Gender_r != Gender_y6 ~ "different",
                              .default = "same")) |>
  filter(sex_same == "same") |>
  select(-sex_same)
# removes 220 records, 36,597 left

# will be using ethnicity recorded in year 6, but can replace with reception if not stated or missing

cohorts_combined <- cohorts_combined |>
  mutate(Ethnicity_y6 = case_when(Ethnicity_y6 == "Unknown" & Ethnicity_r != "Unknown" ~ Ethnicity_r,
                                  .default = Ethnicity_y6))

# check if any NHS numbers are duplicated
cohorts_combined |> 
  group_by(NHSNumber) |> 
  count() |> 
  filter(n>1)

# remove duplicates with distinct()
cohorts_combined <- cohorts_combined |> 
  arrange(desc(DateofMeasurement_r), desc(DateofMeasurement_y6)) |>
  distinct(NHSNumber, .keep_all = T)
```

Figures 13(a-c) show the changes in child BMI category from Reception to Year 6. Note that some bars do not add up to 100% as a result of small number suppression. Use the tabs to move between figures.

::: panel-tabset
## All children

**Figure 13a. Changes in child BMI category from Reception to Year 6.**

The majority of children who were healthy weight in Reception remained healthy weight in Year 6, with around a quarter of the cohort moving to a higher BMI category. Of children who were in a higher BMI category, the majority remained in a higher BMI category - this proportion was highest in children who were obese in Reception, of whom 95% remained either overweight or obese. Meanwhile, around a quarter of children who were overweight moved to a healthy weight. Only a very small proportion of children who were underweight moved to being overweight or obese; the majority moved to healthy weight, with just over a third remaining underweight.

```{r cohort_analysis_all}
#| warning: false
cohorts_combined_by_BMI_Category <- cohorts_combined |> 
  group_by(BMI_Category_Clinical_r, BMI_Category_Clinical_y6) |> 
  count(name = "count") |> 
  ungroup() |> 
  group_by(BMI_Category_Clinical_r) |> 
  mutate(denominator = sum(count))

cohorts_combined_by_BMI_Category <- wilson_ci(cohorts_combined_by_BMI_Category,
                                          cohorts_combined_by_BMI_Category$count,
                                          cohorts_combined_by_BMI_Category$denominator) |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |>
  mutate(BMI_Category_Clinical_r = factor(BMI_Category_Clinical_r,
                                          levels = c("Obese", "Overweight", "Healthy Weight", "Underweight"))) |>
  mutate(BMI_Category_Clinical_y6 = factor(BMI_Category_Clinical_y6,
                                           levels = c("Obese", "Overweight", "Healthy Weight", "Underweight")))

# try using patchwork to get plot like in PHE report

p1 <- cohorts_combined_by_BMI_Category |> 
  filter(BMI_Category_Clinical_r == "Underweight") |> 
  mutate(tooltip_category = case_when(BMI_Category_Clinical_y6 == "Underweight" ~ paste0("Remained ", str_to_lower(BMI_Category_Clinical_y6)),
                                      .default = paste0("Moved to ", str_to_lower(BMI_Category_Clinical_y6)))) |> 
  mutate(tooltip = paste0(tooltip_category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n",
                          count, " children")) |> 
  mutate(Gender = "Persons") |> 
  ggplot(aes(x = pct,
             y = Gender,
             fill = BMI_Category_Clinical_y6,
             group = BMI_Category_Clinical_y6)) +
  geom_col_interactive(aes(tooltip = tooltip)) +
  theme_classic() +
  scale_y_discrete(name = "") +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0, 100),
                     name = "Percentage in weight category in Year 6",
                     labels = scales::label_percent(scale = 1)) +
  scale_fill_manual(values = c(bcc_colours[4:2], bcc_colours[5])) +
  guides(fill = guide_legend(reverse = T,
                             title = NULL)) +
  #theme(legend.position = "top") +
  ggtitle("Underweight in Reception")

p2 <- cohorts_combined_by_BMI_Category |> 
  filter(BMI_Category_Clinical_r == "Healthy Weight") |> 
  mutate(tooltip_category = case_when(BMI_Category_Clinical_y6 == "Healthy Weight" ~ paste0("Remained ", str_to_lower(BMI_Category_Clinical_y6)),
                                      .default = paste0("Moved to ", str_to_lower(BMI_Category_Clinical_y6)))) |> 
  mutate(tooltip = paste0(tooltip_category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n",
                          count, " children")) |> 
  mutate(Gender = "Persons") |> 
  ggplot(aes(x = pct,
             y = Gender,
             fill = BMI_Category_Clinical_y6,
             group = BMI_Category_Clinical_y6)) +
  geom_col_interactive(aes(tooltip = tooltip)) +
  theme_classic() +
  scale_y_discrete(name = "") +
  scale_x_continuous(expand = c(0,0),
                     name = "Percentage in weight category in Year 6",
                     labels = scales::label_percent(scale = 1)) +
  scale_fill_manual(values = c(bcc_colours[4:2], bcc_colours[5])) +
  guides(fill = guide_legend(reverse = T,
                             title = NULL)) +
  #theme(legend.position = "top")  +
  ggtitle("Healthy weight in Reception")

p3 <- cohorts_combined_by_BMI_Category |> 
  filter(BMI_Category_Clinical_r == "Overweight") |> 
  mutate(tooltip_category = case_when(BMI_Category_Clinical_y6 == "Overweight" ~ paste0("Remained ", str_to_lower(BMI_Category_Clinical_y6)),
                                      .default = paste0("Moved to ", str_to_lower(BMI_Category_Clinical_y6)))) |> 
  mutate(tooltip = paste0(tooltip_category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n",
                          count, " children")) |> 
  mutate(Gender = "Persons") |> 
  ggplot(aes(x = pct,
             y = Gender,
             fill = BMI_Category_Clinical_y6,
             group = BMI_Category_Clinical_y6)) +
  geom_col_interactive(aes(tooltip = tooltip)) +
  theme_classic() +
  scale_y_discrete(name = "") +
  scale_x_continuous(expand = c(0,0),
                     name = "Percentage in weight category in Year 6",
                     labels = scales::label_percent(scale = 1)) +
  scale_fill_manual(values = c(bcc_colours[4:2], bcc_colours[5]),
                    drop = F) +
  guides(fill = "none") +
  ggtitle("Overweight in Reception")

p4 <- cohorts_combined_by_BMI_Category |> 
  filter(BMI_Category_Clinical_r == "Obese") |> 
  mutate(tooltip_category = case_when(BMI_Category_Clinical_y6 == "Obese" ~ paste0("Remained ", str_to_lower(BMI_Category_Clinical_y6)),
                                      .default = paste0("Moved to ", str_to_lower(BMI_Category_Clinical_y6)))) |> 
  mutate(tooltip = paste0(tooltip_category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n",
                          count, " children")) |> 
  mutate(Gender = "Persons") |> 
  ggplot(aes(x = pct,
             y = Gender,
             fill = BMI_Category_Clinical_y6,
             group = BMI_Category_Clinical_y6)) +
  geom_col_interactive(aes(tooltip = tooltip)) +
  theme_classic() +
  scale_y_discrete(name = "") +
  scale_x_continuous(expand = c(0,0),
                     name = "Percentage in weight category in Year 6",
                     labels = scales::label_percent(scale = 1)) +
  scale_fill_manual(values = c(bcc_colours[4:2], bcc_colours[5]),
                    drop = F) +
  guides(fill = "none") +
  ggtitle("Obese in Reception")

p5 <- guide_area() / p1 / p2 / p3 / p4 + 
  plot_layout(guides = "collect",
              axes = "collect") &
  theme_minimal() &
  theme(plot.title = element_text(face = "bold",
                                  size = 10),
        legend.position = "top")

girafe(ggobj = p5)
```

## By gender

**Figure 13b. Changes in child BMI category from Reception to Year 6, by gender.**

Boys were less likely to remain a healthy weight than girls, and more likely to either remain obese or move from being overweight to being obese.

A higher proportion of girls than boys who were a healthy weight in Reception remained a healthy weight in Year 6, with a higher proportion of boys moving to being obese. Of children who were overweight in Reception, a higher proportion of boys moved to being obese, while similar proportions of boys and girls moved to healthy weight. A higher proportion of boys who were obese in Reception remained obese, with girls being more likely than boys to move down a category to be overweight.

```{r cohort_analysis_gender}
#| warning: false
cohorts_combined_by_BMI_Category_by_Gender <- cohorts_combined |> 
  group_by(BMI_Category_Clinical_r, BMI_Category_Clinical_y6, Gender_y6) |> 
  count(name = "count") |> 
  ungroup() |> 
  group_by(BMI_Category_Clinical_r, Gender_y6) |> 
  mutate(denominator = sum(count))

cohorts_combined_by_BMI_Category_by_Gender <- wilson_ci(cohorts_combined_by_BMI_Category_by_Gender,
                                                    cohorts_combined_by_BMI_Category_by_Gender$count,
                                                    cohorts_combined_by_BMI_Category_by_Gender$denominator) |>  
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |>
  mutate(BMI_Category_Clinical_r = factor(BMI_Category_Clinical_r,
                                          levels = c("Obese", "Overweight", "Healthy Weight", "Underweight"))) |>
  mutate(BMI_Category_Clinical_y6 = factor(BMI_Category_Clinical_y6,
                                           levels = c("Obese", "Overweight", "Healthy Weight", "Underweight")))

p1 <- cohorts_combined_by_BMI_Category_by_Gender |> 
  filter(BMI_Category_Clinical_r == "Underweight") |> 
  mutate(tooltip_category = case_when(BMI_Category_Clinical_y6 == "Underweight" ~ paste0("Remained ", str_to_lower(BMI_Category_Clinical_y6)),
                                      .default = paste0("Moved to ", str_to_lower(BMI_Category_Clinical_y6)))) |> 
  mutate(tooltip = paste0(tooltip_category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n",
                          count, " children")) |> 
  ggplot(aes(x = pct,
             y = Gender_y6,
             fill = BMI_Category_Clinical_y6,
             group = BMI_Category_Clinical_y6)) +
  geom_col_interactive(aes(tooltip = tooltip)) +
  theme_classic() +
  scale_y_discrete(name = "") +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0, 100),
                     name = "Percentage in weight category in Year 6",
                     labels = scales::label_percent(scale = 1)) +
  scale_fill_manual(values = c(bcc_colours[4:2], bcc_colours[5])) +
  guides(fill = guide_legend(reverse = T,
                             title = NULL)) +
  #theme(legend.position = "top") +
  ggtitle("Underweight in Reception")

p2 <- cohorts_combined_by_BMI_Category_by_Gender |> 
  filter(BMI_Category_Clinical_r == "Healthy Weight") |> 
  mutate(tooltip_category = case_when(BMI_Category_Clinical_y6 == "Healthy Weight" ~ paste0("Remained ", str_to_lower(BMI_Category_Clinical_y6)),
                                      .default = paste0("Moved to ", str_to_lower(BMI_Category_Clinical_y6)))) |> 
  mutate(tooltip = paste0(tooltip_category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n",
                          count, " children")) |> 
  ggplot(aes(x = pct,
             y = Gender_y6,
             fill = BMI_Category_Clinical_y6,
             group = BMI_Category_Clinical_y6)) +
  geom_col_interactive(aes(tooltip = tooltip)) +
  theme_classic() +
  scale_y_discrete(name = "") +
  scale_x_continuous(expand = c(0,0),
                     name = "Percentage in weight category in Year 6",
                     labels = scales::label_percent(scale = 1)) +
  scale_fill_manual(values = c(bcc_colours[4:2], bcc_colours[5])) +
  guides(fill = guide_legend(reverse = T,
                             title = NULL)) +
  #theme(legend.position = "top")  +
  ggtitle("Healthy weight in Reception")

p3 <- cohorts_combined_by_BMI_Category_by_Gender |> 
  filter(BMI_Category_Clinical_r == "Overweight") |> 
  mutate(tooltip_category = case_when(BMI_Category_Clinical_y6 == "Overweight" ~ paste0("Remained ", str_to_lower(BMI_Category_Clinical_y6)),
                                      .default = paste0("Moved to ", str_to_lower(BMI_Category_Clinical_y6)))) |> 
  mutate(tooltip = paste0(tooltip_category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n",
                          count, " children")) |> 
  ggplot(aes(x = pct,
             y = Gender_y6,
             fill = BMI_Category_Clinical_y6,
             group = BMI_Category_Clinical_y6)) +
  geom_col_interactive(aes(tooltip = tooltip)) +
  theme_classic() +
  scale_y_discrete(name = "") +
  scale_x_continuous(expand = c(0,0),
                     name = "Percentage in weight category in Year 6",
                     labels = scales::label_percent(scale = 1)) +
  scale_fill_manual(values = c(bcc_colours[4:2], bcc_colours[5]),
                    drop = F) +
  guides(fill = "none") +
  ggtitle("Overweight in Reception")

p4 <- cohorts_combined_by_BMI_Category_by_Gender |> 
  filter(BMI_Category_Clinical_r == "Obese") |> 
  mutate(tooltip_category = case_when(BMI_Category_Clinical_y6 == "Obese" ~ paste0("Remained ", str_to_lower(BMI_Category_Clinical_y6)),
                                      .default = paste0("Moved to ", str_to_lower(BMI_Category_Clinical_y6)))) |> 
  mutate(tooltip = paste0(tooltip_category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n",
                          count, " children")) |> 
  ggplot(aes(x = pct,
             y = Gender_y6,
             fill = BMI_Category_Clinical_y6,
             group = BMI_Category_Clinical_y6)) +
  geom_col_interactive(aes(tooltip = tooltip)) +
  theme_classic() +
  scale_y_discrete(name = "") +
  scale_x_continuous(expand = c(0,0),
                     name = "Percentage in weight category in Year 6",
                     labels = scales::label_percent(scale = 1)) +
  scale_fill_manual(values = c(bcc_colours[4:2], bcc_colours[5]),
                    drop = F) +
  guides(fill = "none") +
  ggtitle("Obese in Reception")

p5 <- guide_area() / p1 / p2 / p3 / p4 + 
  plot_layout(guides = "collect",
              axes = "collect") &
  theme_minimal() &
  theme(plot.title = element_text(face = "bold",
                                  size = 10),
        legend.position = "top")
girafe(ggobj = p5)
```

## By IDACI quintile (grouped)

**Figure 13c. Changes in child BMI category from Reception to Year 6, by IDACI quintile (grouped).**

Children in more deprived areas were less likely to remain a healthy weight and more likely to move from overweight to obese.

Of children living in IDACI quintile 1 who were a healthy weight in Reception, a lower proportion remained a healthy weight than children in quintiles 3-5, while a higher proportion moved to being obese. A higher proportion of children living in IDACI quintiles 3-5 who were overweight in Reception moved to healthy weight than children in quintile 1, while a lower proportion moved to being obese.There were no significant differences between quintiles in children who were underweight or obese in Reception, likely due to small sample sizes.

```{r cohort_analysis_idaci}
#| warning: false

# group idaci quintiles into 1, 2+3, 4+5 to get round suppression
cohorts_combined_by_BMI_Category_by_IDACI <- cohorts_combined |> 
  mutate(IDACI_2019_Quintile_grouped = case_when(IDACI_2019_Quintile == "1" ~ "Quintile 1",
                                                 IDACI_2019_Quintile == "2" ~ "Quintile 2",
                                                 IDACI_2019_Quintile == "3" ~ "Quintiles 3-5",
                                                 IDACI_2019_Quintile == "4" ~ "Quintiles 3-5",
                                                 IDACI_2019_Quintile == "5" ~ "Quintiles 3-5")) |> 
  group_by(BMI_Category_Clinical_r, BMI_Category_Clinical_y6, IDACI_2019_Quintile_grouped) |> 
  count(name = "count") |> 
  ungroup() |> 
  group_by(BMI_Category_Clinical_r, IDACI_2019_Quintile_grouped) |> 
  mutate(denominator = sum(count))

cohorts_combined_by_BMI_Category_by_IDACI <- wilson_ci(cohorts_combined_by_BMI_Category_by_IDACI,
                                                        cohorts_combined_by_BMI_Category_by_IDACI$count,
                                                        cohorts_combined_by_BMI_Category_by_IDACI$denominator) |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |>
  mutate(BMI_Category_Clinical_r = factor(BMI_Category_Clinical_r,
                                          levels = c("Obese", "Overweight", "Healthy Weight", "Underweight"))) |>
  mutate(BMI_Category_Clinical_y6 = factor(BMI_Category_Clinical_y6,
                                           levels = c("Obese", "Overweight", "Healthy Weight", "Underweight")))

p1 <- cohorts_combined_by_BMI_Category_by_IDACI |> 
  filter(BMI_Category_Clinical_r == "Underweight") |> 
  mutate(IDACI_2019_Quintile_grouped = factor(IDACI_2019_Quintile_grouped,
                                      levels = c("Quintiles 3-5", "Quintile 2", "Quintile 1"))) |>
  mutate(tooltip_category = case_when(BMI_Category_Clinical_y6 == "Underweight" ~ paste0("Remained ", str_to_lower(BMI_Category_Clinical_y6)),
                                      .default = paste0("Moved to ", str_to_lower(BMI_Category_Clinical_y6)))) |> 
  mutate(tooltip = paste0(tooltip_category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n",
                          count, " children")) |> 
  ggplot(aes(x = pct,
             y = IDACI_2019_Quintile_grouped,
             fill = BMI_Category_Clinical_y6,
             group = BMI_Category_Clinical_y6)) +
  geom_col_interactive(aes(tooltip = tooltip)) +
  theme_classic() +
  scale_y_discrete(name = "") +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0, 100),
                     name = "Percentage in weight category in Year 6",
                     labels = scales::label_percent(scale = 1)) +
  scale_fill_manual(values = c(bcc_colours[4:2], bcc_colours[5])) +
  guides(fill = guide_legend(reverse = T,
                             title = NULL)) +
  #theme(legend.position = "top") +
  ggtitle("Underweight in Reception")

p2 <- cohorts_combined_by_BMI_Category_by_IDACI |> 
  filter(BMI_Category_Clinical_r == "Healthy Weight") |> 
  mutate(IDACI_2019_Quintile_grouped = factor(IDACI_2019_Quintile_grouped,
                                      levels = c("Quintiles 3-5", "Quintile 2", "Quintile 1"))) |>
  mutate(tooltip_category = case_when(BMI_Category_Clinical_y6 == "Healthy Weight" ~ paste0("Remained ", str_to_lower(BMI_Category_Clinical_y6)),
                                      .default = paste0("Moved to ", str_to_lower(BMI_Category_Clinical_y6)))) |> 
  mutate(tooltip = paste0(tooltip_category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n",
                          count, " children")) |> 
  ggplot(aes(x = pct,
             y = IDACI_2019_Quintile_grouped,
             fill = BMI_Category_Clinical_y6,
             group = BMI_Category_Clinical_y6)) +
  geom_col_interactive(aes(tooltip = tooltip)) +
  theme_classic() +
  scale_y_discrete(name = "") +
  scale_x_continuous(expand = c(0,0),
                     name = "Percentage in weight category in Year 6",
                     labels = scales::label_percent(scale = 1)) +
  scale_fill_manual(values = c(bcc_colours[4:2], bcc_colours[5])) +
  guides(fill = guide_legend(reverse = T,
                             title = NULL)) +
  #theme(legend.position = "top")  +
  ggtitle("Healthy weight in Reception")

p3 <- cohorts_combined_by_BMI_Category_by_IDACI |> 
  filter(BMI_Category_Clinical_r == "Overweight") |> 
  mutate(tooltip_category = case_when(BMI_Category_Clinical_y6 == "Overweight" ~ paste0("Remained ", str_to_lower(BMI_Category_Clinical_y6)),
                                      .default = paste0("Moved to ", str_to_lower(BMI_Category_Clinical_y6)))) |> 
  mutate(tooltip = paste0(tooltip_category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n",
                          count, " children")) |> 
  mutate(IDACI_2019_Quintile_grouped = factor(IDACI_2019_Quintile_grouped,
                                      levels = c("Quintiles 3-5", "Quintile 2", "Quintile 1"))) |>
  ggplot(aes(x = pct,
             y = IDACI_2019_Quintile_grouped,
             fill = BMI_Category_Clinical_y6,
             group = BMI_Category_Clinical_y6)) +
  geom_col_interactive(aes(tooltip = tooltip)) +
  theme_classic() +
  scale_y_discrete(name = "") +
  scale_x_continuous(expand = c(0,0),
                     name = "Percentage in weight category in Year 6",
                     labels = scales::label_percent(scale = 1)) +
  scale_fill_manual(values = c(bcc_colours[4:2], bcc_colours[5]),
                    drop = F) +
  guides(fill = "none") +
  ggtitle("Overweight in Reception")

p4 <- cohorts_combined_by_BMI_Category_by_IDACI |> 
  filter(BMI_Category_Clinical_r == "Obese") |> 
  mutate(IDACI_2019_Quintile_grouped = factor(IDACI_2019_Quintile_grouped,
                                      levels = c("Quintiles 3-5", "Quintile 2", "Quintile 1"))) |>
  mutate(tooltip_category = case_when(BMI_Category_Clinical_y6 == "Obese" ~ paste0("Remained ", str_to_lower(BMI_Category_Clinical_y6)),
                                      .default = paste0("Moved to ", str_to_lower(BMI_Category_Clinical_y6)))) |> 
  mutate(tooltip = paste0(tooltip_category, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)", "\n",
                          count, " children")) |> 
  ggplot(aes(x = pct,
             y = IDACI_2019_Quintile_grouped,
             fill = BMI_Category_Clinical_y6,
             group = BMI_Category_Clinical_y6)) +
  geom_col_interactive(aes(tooltip = tooltip)) +
  theme_classic() +
  scale_y_discrete(name = "") +
  scale_x_continuous(expand = c(0,0),
                     name = "Percentage in weight category in Year 6",
                     labels = scales::label_percent(scale = 1)) +
  scale_fill_manual(values = c(bcc_colours[4:2], bcc_colours[5]),
                    drop = F) +
  guides(fill = "none") +
  ggtitle("Obese in Reception")

p5 <-guide_area() / p1 / p2 / p3 / p4 + 
  plot_layout(guides = "collect",
              axes = "collect") &
  theme_minimal() &
  theme(plot.title = element_text(face = "bold",
                                  size = 10),
        legend.position = "top")
girafe(ggobj = p5)
```
:::

# Prevalence of Short Stature

Short stature is defined as having a height below the 2nd centile of the UK90 growth reference, according to age and gender. Around 80% of variance in height is attributable to genetic factors, leaving 20% explained by environmental influences such as diet and nutrition, living conditions, parental smoking and childhood illness[^4].

[^4]: McEvoy BP, Visscher PM. Genetics of human height. Econ Hum Biol. 2009

This section explores the prevalence of short stature in children in Birmingham, and some of the factors which may affect this.

```{r short_stature_setup}
#| warning: false
# prevalence of short stature across all children in a year/school year
short_stature_prevalence_3yrs <- ncmp_data_3_years_combined |> 
  group_by(Year, School_Year, short_stature) |> 
  count(name = "count") |> 
  ungroup() |> 
  group_by(Year, School_Year) |> 
  mutate(denominator = sum(count))

short_stature_prevalence_3yrs <- wilson_ci(short_stature_prevalence_3yrs,
                                      short_stature_prevalence_3yrs$count,
                                      short_stature_prevalence_3yrs$denominator) |> 
  filter(short_stature == TRUE) |> 
  select(-short_stature)

# prevalence of short stature by idaci quintile/year/school year
short_stature_prevalence_3yrs_idaci <- ncmp_data_3_years_combined |> 
  group_by(Year, School_Year, IDACI_2019_Quintile, short_stature) |> 
  count(name = "count") |> 
  ungroup() |> 
  group_by(Year, School_Year, IDACI_2019_Quintile) |> 
  mutate(denominator = sum(count))

short_stature_prevalence_3yrs_idaci <- wilson_ci(short_stature_prevalence_3yrs_idaci,
                                            short_stature_prevalence_3yrs_idaci$count,
                                            short_stature_prevalence_3yrs_idaci$denominator) |> 
  filter(short_stature == TRUE) |> 
  select(-short_stature)

# prevalence of short stature by ethnicity/year/school year
short_stature_prevalence_3yrs_ethnicity <- ncmp_data_3_years_combined |> 
  group_by(Year, School_Year, Ethnicity, short_stature) |> 
  count(name = "count") |> 
  ungroup() |> 
  group_by(Year, School_Year, Ethnicity) |> 
  mutate(denominator = sum(count))

short_stature_prevalence_3yrs_ethnicity <- wilson_ci(short_stature_prevalence_3yrs_ethnicity,
                                                short_stature_prevalence_3yrs_ethnicity$count,
                                                short_stature_prevalence_3yrs_ethnicity$denominator) |> 
  filter(short_stature == TRUE) |> 
  select(-short_stature)

# prevalence of short stature by gender/year/school year
short_stature_prevalence_3yrs_gender <- ncmp_data_3_years_combined |> 
  group_by(Year, School_Year, Gender, short_stature) |> 
  count(name = "count") |> 
  ungroup() |> 
  group_by(Year, School_Year, Gender) |> 
  mutate(denominator = sum(count))

short_stature_prevalence_3yrs_gender <- wilson_ci(short_stature_prevalence_3yrs_gender,
                                             short_stature_prevalence_3yrs_gender$count,
                                             short_stature_prevalence_3yrs_gender$denominator) |> 
  filter(short_stature == TRUE) |> 
  select(-short_stature)

# prevalence of short stature by gender/ethnicity/year/school year
short_stature_prevalence_3yrs_gender_ethnicity <- ncmp_data_3_years_combined |> 
  group_by(Year, School_Year, Gender, Ethnicity, short_stature) |> 
  count(name = "count") |> 
  ungroup() |> 
  group_by(Year, School_Year, Gender, Ethnicity) |> 
  mutate(denominator = sum(count))

short_stature_prevalence_3yrs_gender_ethnicity <- wilson_ci(short_stature_prevalence_3yrs_gender_ethnicity,
                                                  short_stature_prevalence_3yrs_gender_ethnicity$count,
                                                  short_stature_prevalence_3yrs_gender_ethnicity$denominator) |> 
  filter(short_stature == TRUE) |> 
  select(-short_stature)
```

## Overview

**Figure 14. Percentage of children classed as having short stature by year group, over time**

Prevalence of short stature is higher in Reception-age children, where there has been no significant change over the past ten years. However, there has been a decrease in prevalence of short stature in Year 6 children in this time.

```{r short_stature_over_time}
#| warning: false

# simple bar chart of short stature prevalence over time (3 year rolling)
graph <- short_stature_prevalence_3yrs |> 
  #filter(short_stature == TRUE) |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(tooltip = paste0(Year, "\n",
                          School_Year, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)")) |>
  ggplot(aes(x = Year, 
             y = pct,
             fill = School_Year)) +
  geom_col_interactive(aes(tooltip = tooltip),
                       position = "dodge") +
  geom_errorbar(aes(ymin = lower_ci,
                    ymax = upper_ci),
                width = 0.2,
                position = position_dodge(width = 0.9)) +
  theme_classic() +
  scale_fill_manual(values = c(bcc_colours),
                    name = "School Year") +
  scale_x_discrete() +
  scale_y_continuous(expand = c(0,0),
                     name = "Percentage of children\n having short stature") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

girafe(ggobj = graph)
```

## Gender

**Figure 15. Percentage of children classed as having short stature, by gender and year group (`{r} periods_short[8]` period)**

In Reception-age children, girls have higher prevalence of short stature than boys. In Year 6 children, there is no significant difference between the genders.

```{r short_stature_gender}
#| warning: false

graph <- short_stature_prevalence_3yrs_gender |> 
  filter(Year == periods[8]) |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(tooltip = paste0(Gender, "\n",
                          School_Year, "\n",
                          round(pct, 2), "% (", round(lower_ci, 2), " - ", round(upper_ci, 2), "%)")) |>
  ggplot(aes(x = School_Year, y = pct,
             fill = Gender)) +
  geom_col_interactive(aes(tooltip = tooltip),
                       position = "dodge") +
  geom_errorbar(aes(ymin = lower_ci,
                    ymax = upper_ci),
                width = 0.2,
                position = position_dodge(width = 0.9)) +
  theme_classic() +
  scale_x_discrete(name = "School Year") +
  scale_y_continuous(expand = c(0,0),
                     name = "Percentage of children\n having short stature",
                     labels = scales::label_percent(scale = 1)) +
  scale_fill_manual(values = c(bcc_colours))

girafe(ggobj = graph)
```

## Deprivation

**Figure 16. Percentage of children classed as having short stature, by IDACI quintile and year group (`{r} periods_short[8]` period)**

In both year groups prevalence of short stature does not differ significantly between quintiles, suggesting short stature is not strongly affected by deprivation.

```{r short_stature_deprivation}
#| warning: false

graph <- short_stature_prevalence_3yrs_idaci |> 
  filter(Year == periods[8]) |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(tooltip = paste0("IDACI Quintile " ,IDACI_2019_Quintile, "\n",
                          School_Year, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)")) |>
  mutate(IDACI_2019_Quintile = case_when(IDACI_2019_Quintile == "5" ~ "5 (least deprived)",
                                         IDACI_2019_Quintile == "1" ~ "1 (most deprived)",
                                         .default = IDACI_2019_Quintile)) |> 
  mutate(IDACI_2019_Quintile = factor(IDACI_2019_Quintile,
                                      levels = c("1 (most deprived)",
                                                 "2",
                                                 "3",
                                                 "4",
                                                 "5 (least deprived)"))) |>
  ggplot(aes(x = School_Year, y = pct,
             fill = IDACI_2019_Quintile)) +
  geom_col_interactive(aes(tooltip = tooltip),
                       position = "dodge") +
  geom_errorbar(aes(ymin = lower_ci,
                    ymax = upper_ci),
                width = 0.2,
                position = position_dodge(width = 0.9)) +
  theme_classic() +
  scale_x_discrete(name = "School Year") +
  scale_y_continuous(expand = c(0,0),
                     name = "Percentage of children\n having short stature",
                     labels = scales::label_percent(scale = 1)) +
  scale_fill_manual(values = c(bcc_colours),
                    name = "IDACI 2019 Quintile")

girafe(ggobj = graph)
```

## Ethnicity

**Figure 17. Percentage of children classed as having short stature, by ethnicity and year group (`{r} periods_short[8]` period)**

Children of Asian, White and Other ethnicity in Reception have higher prevalence of short stature than Black and Mixed ethnicity children. In Year 6, Black children have lower prevalence of short stature than children of Asian and Other ethnicity.

```{r short_stature_ethnicity}
#| warning: false

graph <- short_stature_prevalence_3yrs_ethnicity |> 
  filter(Year == periods[8]) |> 
  mutate(pct = case_when(count <= 7 ~ NA_real_,
                         .default = pct),
         lower_ci = case_when(count <= 7 ~ NA_real_,
                              .default = lower_ci),
         upper_ci = case_when(count <= 7 ~ NA_real_,
                              .default = upper_ci)) |> 
  mutate(tooltip = paste0(Ethnicity, "\n",
                          School_Year, "\n",
                          round(pct, 1), "% (", round(lower_ci, 1), " - ", round(upper_ci, 1), "%)")) |>
  ggplot(aes(x = School_Year, y = pct,
             fill = Ethnicity)) +
  geom_col_interactive(aes(tooltip = tooltip),
                       position = "dodge") +
  geom_errorbar(aes(ymin = lower_ci,
                    ymax = upper_ci),
                width = 0.2,
                position = position_dodge(width = 0.9)) +
  theme_classic() +
  scale_x_discrete(name = "School Year") +
  scale_y_continuous(expand = c(0,0),
                     name = "Percentage of children\n having short stature",
                     labels = scales::label_percent(scale = 1)) +
  scale_fill_manual(values = c(bcc_colours))

girafe(ggobj = graph)
```
